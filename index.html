<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Prototype – Sistem Imunisasi Anak v1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20width%3D%2232px%22%20height%3D%2232px%22%20viewBox%3D%220%200%200.8%200.8%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20fill-rule%3D%22evenodd%22%20clip-rule%3D%22evenodd%22%20d%3D%22M0.174%200.429a0.1%200.1%200%200%200%200%200.141l0.057%200.057a0.1%200.1%200%200%200%200.141%200l0.279%20-0.279a0.1%200.1%200%200%200%200.029%20-0.073l-0.001%20-0.056a0.1%200.1%200%200%200%20-0.099%20-0.098l-0.055%20-0.001a0.1%200.1%200%200%200%20-0.072%200.029zM0.594%200.291l-0.279%200.279a0.02%200.02%200%200%201%20-0.028%200l-0.057%20-0.057a0.02%200.02%200%200%201%200%20-0.028l0.279%20-0.279a0.02%200.02%200%200%201%200.014%20-0.006l0.055%200.001a0.02%200.02%200%200%201%200.02%200.02l0.001%200.056a0.02%200.02%200%200%201%20-0.006%200.015%22%20fill%3D%22%231e3a8a%22%2F%3E%3Cpath%20d%3D%22M0.441%200.464a0.02%200.02%200%201%201%20-0.028%200.028l-0.057%20-0.057a0.02%200.02%200%201%201%200.028%20-0.028z%22%20fill%3D%22%231e3a8a%22%2F%3E%3Cpath%20d%3D%22M0.229%200.676a0.04%200.04%200%201%201%20-0.057%200.057l-0.113%20-0.113a0.04%200.04%200%201%201%200.057%20-0.057z%22%20fill%3D%22%231e3a8a%22%2F%3E%3Cpath%20d%3D%22M0.375%200.667a0.04%200.04%200%201%201%20-0.057%200.057l-0.239%20-0.239a0.04%200.04%200%201%201%200.057%20-0.057z%22%20fill%3D%22%231e3a8a%22%2F%3E%3Cpath%20d%3D%22M0.526%200.379a0.02%200.02%200%201%201%20-0.028%200.028l-0.057%20-0.057a0.02%200.02%200%201%201%200.028%20-0.028z%22%20fill%3D%22%231e3a8a%22%2F%3E%3Cpath%20d%3D%22M0.2%200.657%200.143%200.6%200.2%200.543%200.257%200.6z%22%20fill%3D%22%231e3a8a%22%2F%3E%3Cpath%20d%3D%22M0.719%200.039a0.03%200.03%200%200%201%200.042%200.042l-0.12%200.12a0.03%200.03%200%200%201%20-0.042%20-0.042z%22%20fill%3D%22%231e3a8a%22%2F%3E%3C%2Fsvg%3E" />
      <style>
      body {
        font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial
      }

      :root {
        --danger-500: #be123c
      }

      .card {
        background: #fff;
        border-radius: 1rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, .05);
        border: 1px solid rgba(0, 0, 0, .05)
      }

      .badge {
        font-size: .75rem;
        line-height: 1rem;
        padding: .25rem .75rem;
        border-radius: 9999px;
        font-weight: 600;
        display: inline-block;
        border-width: 1px
      }

      .badge {
        letter-spacing: 0.2px
      }

      .b-green {
        background: #ecfdf5;
        color: #047857;
        border-color: #bbf7d0
      }

      .b-amber {
        background: #fffbeb;
        color: #b45309;
        border-color: #fde68a
      }

      .b-red {
        background: #fff1f2;
        color: var(--danger-500);
        border-color: #fecdd3
      }

      .btn {
        padding: .65rem .9rem;
        border-radius: .75rem;
        font-weight: 600
      }

      .btn-primary {
        background: #4f46e5;
        color: #fff
      }

      .btn-primary:hover {
        background: #4338ca
      }

      .btn-ghost {
        background: #f1f5f9;
        color: #334155
      }

      .btn-ghost:hover {
        background: #e2e8f0
      }

      .btn-danger {
        background: #fff1f2;
        color: var(--danger-500);
        border-color: #fecdd3;
        border-width: 1px;
        padding: .5rem .85rem;
        border-radius: .6rem;
        font-weight: 600
      }

      .btn-danger:hover {
        background: #ffe4e8
      }

      /* textual low-priority danger button (restore layout) */
      .btn-danger.text {
        padding: .5rem .85rem;
        border-radius: .6rem;
        font-weight: 600
      }

      /* inline text-style button for low-priority actions (match .btn) */
      .btn-text {
        display: inline-flex;
        align-items: center;
        gap: .4rem;
        background: #fff;
        border: 1px solid rgba(0, 0, 0, 0.03);
        padding: .65rem .9rem;
        border-radius: .75rem;
        color: var(--danger-500);
        font-weight: 600;
        cursor: pointer;
        font-size: 0.95rem
      }

      .btn-text.w-full {
        width: 100%;
        justify-content: center
      }

      .btn-text:hover {
        background: #fff1f2
      }

      .btn-text:focus {
        outline: 2px solid rgba(79, 70, 229, 0.08);
        outline-offset: 2px
      }

      .btn-text:focus-visible {
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.06);
        border-color: rgba(79, 70, 229, 0.06)
      }

      /* anchor-styled tertiary destructive link (accessibility first) */
      .btn-text-link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: .4rem;
        background: transparent;
        border: none;
        padding: .65rem .9rem;
        border-radius: .75rem;
        color: var(--danger-500);
        font-weight: 600;
        cursor: pointer;
        text-decoration: none
      }

      .btn-text-link:hover {
        background: #fff1f2
      }

      .btn-text-link:focus {
        outline: 2px solid rgba(79, 70, 229, 0.08);
        outline-offset: 2px
      }

      /* Dividers between action buttons: vertical on sm+, horizontal on mobile */
      .mt-3.grid.grid-cols-3.gap-2>* {
        position: relative
      }

      @media (min-width:640px) {
        .mt-3.grid.grid-cols-3.gap-2>*:not(:last-child) {
          border-right: 1px solid rgba(15, 23, 42, 0.04);
          padding-right: .6rem
        }
      }

      @media (max-width:639px) {
        .flex.flex-col.sm\:flex-row>*:not(:last-child) {
          border-bottom: 1px solid rgba(15, 23, 42, 0.04);
          padding-bottom: .5rem
        }
      }

      [data-view] {
        display: none
      }

      [data-view].active {
        display: block
      }

      .row-form {
        display: none
      }

      .row-form.show {
        display: block
      }

      /* Slightly larger spacing inside status/stat cards */
      .card p,
      .card div.text-sm {
        margin-top: 0.35rem
      }

      .b-slate {
        background: #f1f5f9;
        color: #334155;
        border-color: #e2e8f0
      }
      /*#program-completeness { display: none; }*/
    </style>
  </head>
  <body class="bg-slate-50">
    <!-- Global Logout (overlay) -->
    <button id="btnLogout" class="fixed z-50 top-4 right-4 p-2 rounded-full bg-white/80 backdrop-blur border border-slate-200 shadow hover:bg-white text-slate-600" title="Keluar" aria-label="Keluar" onclick="AUTH.logout()" style="display:none">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4" />
        <path d="M16 17l5-5-5-5" />
        <path d="M21 12H9" />
      </svg>
    </button>
    <!-- LOGIN -->
    <section id="view-login" data-view class="max-w-xl mx-auto px-5 py-10">
      <div class="text-center mb-8">
        <div class="h-16 w-16 mx-auto rounded-full bg-indigo-50 grid place-items-center text-indigo-600">
          <!-- Ikon Suntikan (bold, miring 45°) -->
          <?xml version="1.0" encoding="utf-8"?>
<!-- License: PD. Made by Mary Akveo: https://maryakveo.com/ -->
<svg width="32px" height="32px" viewBox="0 0 0.8 0.8" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M0.174 0.429a0.1 0.1 0 0 0 0 0.141l0.057 0.057a0.1 0.1 0 0 0 0.141 0l0.279 -0.279a0.1 0.1 0 0 0 0.029 -0.073l-0.001 -0.056a0.1 0.1 0 0 0 -0.099 -0.098l-0.055 -0.001a0.1 0.1 0 0 0 -0.072 0.029zM0.594 0.291l-0.279 0.279a0.02 0.02 0 0 1 -0.028 0l-0.057 -0.057a0.02 0.02 0 0 1 0 -0.028l0.279 -0.279a0.02 0.02 0 0 1 0.014 -0.006l0.055 0.001a0.02 0.02 0 0 1 0.02 0.02l0.001 0.056a0.02 0.02 0 0 1 -0.006 0.015" fill="#000000"/><path d="M0.441 0.464a0.02 0.02 0 1 1 -0.028 0.028l-0.057 -0.057a0.02 0.02 0 1 1 0.028 -0.028z" fill="#000000"/><path d="M0.229 0.676a0.04 0.04 0 1 1 -0.057 0.057l-0.113 -0.113a0.04 0.04 0 1 1 0.057 -0.057z" fill="#000000"/><path d="M0.375 0.667a0.04 0.04 0 1 1 -0.057 0.057l-0.239 -0.239a0.04 0.04 0 1 1 0.057 -0.057z" fill="#000000"/><path d="M0.526 0.379a0.02 0.02 0 1 1 -0.028 0.028l-0.057 -0.057a0.02 0.02 0 1 1 0.028 -0.028z" fill="#000000"/><path d="M0.2 0.657 0.143 0.6 0.2 0.543 0.257 0.6z" fill="#000000"/><path d="M0.719 0.039a0.03 0.03 0 0 1 0.042 0.042l-0.12 0.12a0.03 0.03 0 0 1 -0.042 -0.042z" fill="#000000"/></svg>
        </div>
        <h1 class="mt-4 text-3xl font-extrabold text-slate-900">Sistem Imunisasi Anak</h1>
      </div>
      <div class="card p-6">
        <label class="block text-slate-700 font-semibold">Username</label>
        <input id="login-username" class="mt-2 w-full px-4 py-4 rounded-xl border border-slate-200" placeholder="username" />
        <label class="block text-slate-700 font-semibold mt-4">Password</label>
        <input id="login-password" type="password" class="mt-2 w-full px-4 py-4 rounded-xl border border-slate-200" placeholder="••••••••" />
        <!--  <div class="flex items-center justify-between mt-3"><label class="inline-flex items-center gap-2 text-slate-600 text-sm"><input id="login-remember" type="checkbox" class="rounded"> Ingat saya
      </label><a class="text-slate-400 text-sm" href="#" onclick="alert('Hubungi admin untuk reset sandi');return false;">Lupa kata sandi?</a></div> -->
        <button id="btnLogin" class="btn btn-primary w-full mt-5">Masuk</button>
        <p id="login-error" class="text-sm text-rose-600 mt-3 hidden">Username atau password salah.</p>
      </div>
    </section>
    <!-- HUB (Landing setelah login) -->
    <section id="view-hub" data-view class="max-w-xl mx-auto px-5 py-10">
      <div class="text-center mb-8">
        <div class="h-16 w-16 mx-auto rounded-full bg-indigo-50 grid place-items-center text-indigo-600">
          <!-- Ikon Suntikan (bold, miring 45°) -->
          <?xml version="1.0" encoding="utf-8"?>
<!-- License: PD. Made by Mary Akveo: https://maryakveo.com/ -->
<svg width="32px" height="32px" viewBox="0 0 0.8 0.8" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M0.174 0.429a0.1 0.1 0 0 0 0 0.141l0.057 0.057a0.1 0.1 0 0 0 0.141 0l0.279 -0.279a0.1 0.1 0 0 0 0.029 -0.073l-0.001 -0.056a0.1 0.1 0 0 0 -0.099 -0.098l-0.055 -0.001a0.1 0.1 0 0 0 -0.072 0.029zM0.594 0.291l-0.279 0.279a0.02 0.02 0 0 1 -0.028 0l-0.057 -0.057a0.02 0.02 0 0 1 0 -0.028l0.279 -0.279a0.02 0.02 0 0 1 0.014 -0.006l0.055 0.001a0.02 0.02 0 0 1 0.02 0.02l0.001 0.056a0.02 0.02 0 0 1 -0.006 0.015" fill="#000000"/><path d="M0.441 0.464a0.02 0.02 0 1 1 -0.028 0.028l-0.057 -0.057a0.02 0.02 0 1 1 0.028 -0.028z" fill="#000000"/><path d="M0.229 0.676a0.04 0.04 0 1 1 -0.057 0.057l-0.113 -0.113a0.04 0.04 0 1 1 0.057 -0.057z" fill="#000000"/><path d="M0.375 0.667a0.04 0.04 0 1 1 -0.057 0.057l-0.239 -0.239a0.04 0.04 0 1 1 0.057 -0.057z" fill="#000000"/><path d="M0.526 0.379a0.02 0.02 0 1 1 -0.028 0.028l-0.057 -0.057a0.02 0.02 0 1 1 0.028 -0.028z" fill="#000000"/><path d="M0.2 0.657 0.143 0.6 0.2 0.543 0.257 0.6z" fill="#000000"/><path d="M0.719 0.039a0.03 0.03 0 0 1 0.042 0.042l-0.12 0.12a0.03 0.03 0 0 1 -0.042 -0.042z" fill="#000000"/></svg>
        </div>
        <h1 class="mt-4 text-3xl font-extrabold text-slate-900">Sistem Imunisasi Anak</h1>
        <p class="text-slate-500">Pilih menu untuk memulai</p>
      </div>
      <div class="grid gap-4">
        <!-- Kartu: Catat Imunisasi -->
        <div id="cardGoImmunize" class="card p-5 cursor-pointer transition ring-0 hover:ring-2 hover:ring-indigo-200 group" role="button" tabindex="0" aria-label="Buka Catat Imunisasi">
          <div class="flex items-start gap-4">
            <div class="h-11 w-11 rounded-xl bg-indigo-50 text-indigo-600 grid place-items-center">
              <svg width="32px" height="32px" viewBox="0 0 0.96 0.96" id="SVGRoot" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:svg="http://www.w3.org/2000/svg"><defs id="defs2"/><g id="layer1"><path d="M0.477 0.08c-0.051 0.001 -0.098 0.015 -0.134 0.04 -0.036 0.025 -0.063 0.063 -0.063 0.109l0 -0.003 0 0.003 0 0v0.001c0 0.004 -0.003 0.023 -0.005 0.052 -0.002 0.032 -0.003 0.069 0.006 0.103 0.008 0.033 0.029 0.077 0.047 0.118 0.009 0.02 0.011 0.023 0.017 0.036l-0.242 0.104 -0.003 0.001 -0.001 0a0.04 0.04 0 0 0 -0.008 0.005l0 0a0.04 0.04 0 0 0 -0.004 0.004l0 0.001 -0.002 0.002 0 0.001 -0.002 0.003 0 0 0 0 -0.001 0.002 0 0.001a0.04 0.04 0 0 0 -0.003 0.017V0.84a0.04 0.04 0 0 0 0.04 0.04h0.56a0.04 0.04 0 0 0 0.04 -0.04 0.04 0.04 0 0 0 -0.04 -0.04H0.16v-0.094l0.256 -0.11a0.04 0.04 0 0 0 0.021 -0.053l-0.001 -0.002 0 -0.001 0 0c-0.001 -0.001 -0.016 -0.033 -0.034 -0.071 -0.018 -0.039 -0.038 -0.087 -0.042 -0.104 -0.004 -0.016 -0.005 -0.051 -0.004 -0.079s0.005 -0.05 0.005 -0.05A0.04 0.04 0 0 0 0.36 0.23v-0.001c0 -0.014 0.008 -0.029 0.029 -0.044S0.441 0.16 0.478 0.16H0.48c0.037 0 0.069 0.011 0.091 0.025S0.6 0.215 0.6 0.229a0.04 0.04 0 0 0 0 0.005s0.003 0.022 0.005 0.051 0 0.063 -0.004 0.08c-0.004 0.017 -0.024 0.065 -0.042 0.105a2.88 2.88 0 0 1 -0.035 0.073l-0.001 0.003 0 0 -0.001 0.002 -0.001 0.002 0 0.002 0 0 0 0.002 0 0.003v0l0 0.003 0 0.003 0 0.003 0 0.001 0 0.001 0.001 0.002 0.001 0.003 0.001 0.002 0 0.001 0.001 0.003 0.002 0.003 0.002 0.002 0.001 0.001 0.001 0.001 0.001 0.001 0.002 0.002 0 0h0l0.002 0.002 0.003 0.002 0.003 0.002 0 0 0.003 0.001 0 0 0.002 0.001 0.001 0 0.119 0.04a0.04 0.04 0 0 0 0.051 -0.025 0.04 0.04 0 0 0 -0.025 -0.051l-0.077 -0.026c0.006 -0.013 0.008 -0.015 0.016 -0.034 0.019 -0.041 0.039 -0.085 0.047 -0.118 0.009 -0.034 0.008 -0.072 0.006 -0.104 -0.002 -0.032 -0.005 -0.057 -0.005 -0.057 -0.002 -0.044 -0.029 -0.081 -0.064 -0.105 -0.037 -0.025 -0.084 -0.039 -0.135 -0.039h-0.003M0.8 0.6a0.04 0.04 0 0 0 -0.04 0.04v0.04h-0.04a0.04 0.04 0 0 0 -0.04 0.04 0.04 0.04 0 0 0 0.04 0.04h0.04v0.04a0.04 0.04 0 0 0 0.04 0.04 0.04 0.04 0 0 0 0.04 -0.04v-0.04h0.04a0.04 0.04 0 0 0 0.04 -0.04 0.04 0.04 0 0 0 -0.04 -0.04h-0.04v-0.04a0.04 0.04 0 0 0 -0.04 -0.04" id="path3110" style="color:#000000;font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:medium;line-height:normal;font-family:sans-serif;font-variant-ligatures:normal;font-variant-position:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-alternates:normal;font-variant-east-asian:normal;font-feature-settings:normal;font-variation-settings:normal;text-indent:0;text-align:start;text-decoration:none;text-decoration-line:none;text-decoration-style:solid;text-decoration-color:#000000;letter-spacing:normal;word-spacing:normal;text-transform:none;writing-mode:lr-tb;direction:ltr;text-orientation:mixed;dominant-baseline:auto;baseline-shift:baseline;text-anchor:start;white-space:normal;shape-padding:0;shape-margin:0;inline-size:0;clip-rule:nonzero;display:inline;overflow:visible;visibility:visible;isolation:auto;mix-blend-mode:normal;color-interpolation:sRGB;color-interpolation-filters:linearRGB;solid-color:#000000;solid-opacity:1;vector-effect:none;fill:#000000;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;color-rendering:auto;image-rendering:auto;shape-rendering:auto;text-rendering:auto;enable-background:accumulate;stop-color:#000000;stop-opacity:1;opacity:1"/></g></svg>
            </div>
            <div class="flex-1">
              <h3 class="font-semibold text-slate-800">Catat Imunisasi</h3>
              <p class="text-sm text-slate-600 mt-1">Cari anak dengan NIK dan input imunisasi hari ini.</p>
            </div>
            <!-- panah kanan tebal, ujung bulat -->
            <div class="h-10 w-10 grid place-items-center">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-6 w-6 text-slate-400 group-hover:text-slate-600" fill="none" stroke="currentColor" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M8 4l8 8-8 8" />
              </svg>
            </div>
          </div>
        </div>
        <!-- Kartu: Daftar Anak -->
        <div id="cardGoList" class="card p-5 cursor-pointer transition ring-0 hover:ring-2 hover:ring-indigo-200 group" role="button" tabindex="0" aria-label="Buka Daftar Anak">
          <div class="flex items-start gap-4">
            <div class="h-11 w-11 rounded-xl bg-indigo-50 text-indigo-600 grid place-items-center">
              <svg fill="#000000" width="32px" height="32px" viewBox="0 0 0.96 0.96" xmlns="http://www.w3.org/2000/svg"><path d="M0.401 0.723a0.32 0.32 0 0 0 0.158 -0.041l0.133 0.133a0.087 0.087 0 0 0 0.122 -0.122l-0.133 -0.133a0.321 0.321 0 0 0 -0.507 -0.385 0.321 0.321 0 0 0 0.227 0.549M0.231 0.231A0.241 0.241 0 1 1 0.16 0.401a0.24 0.24 0 0 1 0.071 -0.171"/></svg>
            </div>
            <div class="flex-1">
              <h3 class="font-semibold text-slate-800">Daftar Anak</h3>
              <p class="text-sm text-slate-600 mt-1">Lihat dan kelola seluruh anak terdaftar.</p>
            </div>
            <div class="h-10 w-10 grid place-items-center">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-6 w-6 text-slate-400 group-hover:text-slate-600" fill="none" stroke="currentColor" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M8 4l8 8-8 8" />
              </svg>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- DAFTAR ANAK -->
    <section id="view-list" data-view class="max-w-xl mx-auto px-5 py-6">
      <div class="flex items-center gap-3 text-slate-700 mb-4">
        <button class="p-2 -ml-2 hover:bg-slate-100 rounded-full" onclick="nav('hub')" aria-label="Kembali">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 18l-6-6 6-6" />
          </svg>
        </button>
        <span>Daftar Anak</span>
      </div>
      <div class="card p-5">
        <label class="block text-slate-700 font-semibold">Cari (Nama/NIK)</label>
        <input id="list-search" class="mt-2 w-full px-4 py-3 rounded-xl border border-slate-200" placeholder="Ketik nama atau NIK..." />
      </div>
      <div id="list-results" class="mt-4">
        <!-- hasil render diisi via JS -->
      </div>
    </section>
    <!-- HOME -->
    <section id="view-home" data-view class="max-w-xl mx-auto px-5 py-10">
      <div class="text-center mb-10">
        <div class="flex items-center gap-3 text-slate-700 mb-4">
          <button class="p-2 -ml-2 hover:bg-slate-100 rounded-full" onclick="nav('hub')" aria-label="Kembali">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 18l-6-6 6-6" />
            </svg>
          </button>
          <span>Catat Imunisasi</span>
        </div>
        <h1 class="mt-4 text-3xl font-extrabold text-slate-900">Input NIK untuk memulai pencatatan</h1>
        <!-- 
    <p class="text-slate-500">Input NIK untuk memulai pencatatan</p> -->
      </div>
      <div class="card p-6">
        <label class="block text-slate-700 font-semibold">Nomor Induk Kependudukan (NIK)</label>
        <div class="mt-2">
          <input id="nikInput" maxlength="16" inputmode="numeric" class="w-full px-4 py-4 rounded-xl border border-slate-200" placeholder="Masukkan 16 digit NIK" />
          <div class="text-xs text-slate-400 mt-1">
            <span id="nikCount">0</span>/16 digit
          </div>
        </div>
        <div class="flex gap-3 mt-4">
          <button id="btnCari" class="btn btn-primary flex-1">Cari</button>
          <!-- <button id="btnTambahBaru" class="btn btn-ghost" title="Registrasi cepat anak baru">+</button> -->
        </div>
      </div>
    </section>
    <!-- REGISTER -->
    <section id="view-register" data-view class="max-w-xl mx-auto px-5 py-6">
      <div class="flex items-center gap-3 text-slate-700 mb-4">
        <button class="p-2 -ml-2 hover:bg-slate-100 rounded-full" onclick="nav('home')">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 18l-6-6 6-6" />
          </svg>
        </button>
        <span>Kembali</span>
      </div>
      <h2 class="text-3xl font-extrabold text-slate-900">Registrasi Anak Baru</h2>
      <p class="text-slate-500" id="reg-nik">NIK: -</p>
      <div class="card p-6 mt-4">
        <label class="block text-slate-700 font-semibold">Nama Lengkap Anak <span class="text-rose-600">*</span>
        </label>
        <input id="reg-name" class="mt-2 w-full px-4 py-4 rounded-xl border border-slate-200" placeholder="Masukkan nama lengkap" />
        <div class="grid grid-cols-2 gap-3 mt-4">
          <div>
            <label class="block text-slate-700 font-semibold">Tanggal Lahir <span class="text-rose-600">*</span>
            </label>
            <input id="reg-dob" type="date" class="mt-2 w-full px-4 py-4 rounded-xl border border-slate-200" />
            <p id="reg-usia" class="text-sm text-slate-500 mt-1">Usia: -</p>
          </div>
          <div>
            <label class="block text-slate-700 font-semibold">Jenis Kelamin</label>
            <select id="reg-sex" class="mt-2 w-full px-4 py-4 rounded-xl border border-slate-200">
              <option value="M">Laki-laki</option>
              <option value="F">Perempuan</option>
            </select>
          </div>
        </div>
        <label class="block text-slate-700 font-semibold mt-4">Nama Orang Tua / Wali <span class="text-rose-600">*</span>
        </label>
        <input id="reg-parent" class="mt-2 w-full px-4 py-4 rounded-xl border border-slate-200" placeholder="Masukkan nama orang tua" />
        <button id="btnSimpanReg" class="btn btn-primary w-full mt-5">Simpan Data</button>
      </div>
    </section>
    <!-- CHILD DASHBOARD -->
    <section id="view-child" data-view class="pb-28">
      <div class="bg-indigo-500 text-white">
        <div class="max-w-xl mx-auto px-5 py-4 flex items-center gap-3">
          <button onclick="nav('home')" class="p-2 -ml-2 hover:bg-white/10 rounded-full">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 18l-6-6 6-6" />
            </svg>
          </button>
          <span>Kembali</span>
        </div>
      </div>
        <main class="max-w-xl mx-auto px-5 -mt-8">
    <!-- Kartu identitas anak -->
    <div class="card p-5 mt-10">
      <div class="flex items-start gap-4">
        <div class="flex-1">
          <h1 id="c-name" class="text-xl font-semibold">-</h1>
        </div>
      </div>
      <!-- key–value dua kolom -->
      <div class="grid grid-cols-2 gap-y-2 gap-x-6 mt-4 mx-auto text-slate-700">
        <div class="text-slate-500">NIK</div>           <div id="c-nik" class="text-right font-medium">-</div>
        <div class="text-slate-500">Jenis Kelamin</div> <div id="c-sex" class="text-right">-</div>
        <div class="text-slate-500">Tanggal Lahir</div> <div id="c-dob" class="text-right">-</div>
        <div class="text-slate-500">Usia</div>          <div id="c-age" class="text-right">-</div>
        <div class="text-slate-500">Orang Tua / Wali</div><div id="c-parent" class="text-right">-</div>
      </div>
<main class="max-w-xl mx-auto mt-4 md:mt-6">
        <div class="grid grid-cols-2 gap-4 mt-4">
          <!-- Selesai -->
          <div class="card p-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <span class="h-6 w-6 rounded-full grid place-items-center bg-green-100 text-green-700">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 6L9 17l-5-5" />
                  </svg>
                </span>
                <span class="text-sm text-slate-700 font-medium">Jadwal Ideal</span>
              </div>
              <div id="s-done" class="text-3xl font-bold tabular-nums">0</div>
            </div>
          </div>
          <!-- Jadwal Kejar -->
          <div class="card p-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <span class="h-6 w-6 rounded-full grid place-items-center bg-amber-100 text-amber-700">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 8v4l3 3" />
                    <circle cx="12" cy="12" r="9" />
                  </svg>
                </span>
                <span class="text-sm text-slate-700 font-medium">Jadwal Kejar</span>
              </div>
              <div id="s-due" class="text-3xl font-bold tabular-nums">0</div>
            </div>
          </div>
          <!-- Belum Dicatat -->
          <div class="card p-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <span class="h-6 w-6 rounded-full grid place-items-center bg-rose-100 text-rose-700">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="9" />
                    <path d="M15 9l-6 6m0-6l6 6" />
                  </svg>
                </span>
                <span class="text-sm text-slate-700 font-medium">Belum Dicatat</span>
              </div>
              <div id="s-late" class="text-3xl font-bold tabular-nums">0</div>
            </div>
          </div>
          <!-- Tidak Diberikan -->
          <div class="card p-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <span class="h-6 w-6 rounded-full grid place-items-center bg-slate-100 text-slate-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="9" />
                    <path d="M8 12h8" />
                  </svg>
                </span>
                <span class="text-sm text-slate-700 font-medium">Tidak Diberikan</span>
              </div>
              <div id="s-notgiven" class="text-3xl font-bold tabular-nums">0</div>
            </div>
          </div>
        </div>
        <!-- DRAFT BANNER (muncul hanya saat ada draft) -->
<div id="draft-banner" class="hidden px-4 py-3 mt-4 rounded-xl border border-amber-200 bg-amber-50 text-amber-900">
  <div class="flex items-start justify-between gap-3">
    <div class="text-sm leading-5">
      <b>Ada perubahan yang belum disubmit.</b>
      <div id="draft-summary" class="text-amber-800/90 mt-0.5">–</div>
    </div>
    <div class="flex gap-2 shrink-0">
      <button id="btnDraftDiscard" class="btn btn-ghost">Buang Draft</button>
      <button id="btnDraftSubmit" class="btn btn-primary">Submit &amp; Simpan</button>
    </div>
  </div>
</div>

        <!-- HIGHLIGHT: Program Completeness (IDL / IBL / ISL / IRL) -->
          <!-- Tab bar -->
    <div class="mt-5 card">
      <div class="px-5 pt-4">
        <div class="grid grid-cols-2">
          <button id="tab-btn-imun" class="py-3 font-semibold text-indigo-700 
          border-b-2 border-indigo-600 hover:bg-indigo-600/10
          focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-300">Status Imunisasi</button>
          <button id="tab-btn-weigh" class="py-3 font-semibold text-indigo-700 
          border-b-2 border-indigo-600 hover:bg-indigo-600/10
          focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-300">Riwayat Penimbangan</button>
        </div>
      </div>

        <div class="max-w-xl mx-auto px-5">
          <div class="flex items-center gap-4">
            <div class="flex-1">
              <p id="c-meta" class="text-sm text-white/90">-</p>
            </div>
          </div>
        </div><div id="tab-panel-imun" class="block">
        <!-- kelengkapan (IDL/IBL/BIAS/IRL) -->
        <section class="px-5">
          <div id="program-completeness" class="card p-4 bg-indigo-50 border border-indigo-100">
            <h3 class="text-slate-800 font-semibold mb-2">Kelengkapan Imunisasi</h3>
            <div class="space-y-2 text-sm">
              <div class="flex items-center justify-between"><span class="text-slate-600">IDL (0–11 bln)</span><span id="chip-idl" class="badge b-amber">Tidak</span></div>
              <div class="flex items-center justify-between"><span class="text-slate-600">IBL (12–23 bln)</span><span id="chip-ibl" class="badge b-amber">Tidak</span></div>
              <div class="flex items-center justify-between"><span class="text-slate-600">ISL (Usia SD)</span><span id="chip-bias" class="badge b-amber">Tidak</span></div>
              <div class="flex items-center justify-between"><span class="text-slate-600">IRL (Kelas 6)</span><span id="chip-irl" class="badge b-amber">Tidak</span></div>
            </div>
          </div>
        </section>
        <section class="mt-5">
          <div id="vax-list" class="divide-y divide-slate-100"></div>
        </section>
      </div>
                 <!-- Panel: Penimbangan -->
      <div id="tab-panel-weigh" class="block">
        <div id="measure-list" class="p-1 px-5 py-1"></div>
        <div class="flex items-center justify-between px-5 py-4 border-y border-slate-100">
          <button id="btnAddMeasure" class="btn btn-primary w-full">+ Tambah</button>
        </div>
      </div>
      </div>
        </section>
    </main>
    </div>
    <!-- VIEW: PENIMBANGAN INPUT -->
    <section id="view-weigh" data-view class="max-w-xl mx-auto px-5 py-6">
      <div class="flex items-center gap-3 text-slate-700 mb-4">
        <button class="p-2 -ml-2 hover:bg-slate-100 rounded-full" onclick="nav('child')">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 18l-6-6 6-6" />
          </svg>
        </button>
        <span>Kembali</span>
      </div>
      <h2 class="text-3xl font-extrabold text-slate-900">Input Penimbangan</h2>
      <p class="text-slate-500" id="w-child">-</p>
      <div class="card p-6 mt-4">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-slate-700 font-semibold">Tanggal Penimbangan</label>
            <input id="w-date" type="date" class="mt-2 w-full px-4 py-4 rounded-xl border border-slate-200" />
          </div>
          <div>
            <label class="block text-slate-700 font-semibold">Jenis Kelamin</label>
            <select id="w-sex" class="mt-2 w-full px-4 py-4 rounded-xl border border-slate-200">
              <option value="M">Laki-laki</option>
              <option value="F">Perempuan</option>
            </select>
          </div>
        </div>
        <label class="block text-slate-700 font-semibold mt-4">Berat Badan (kg)</label>
        <input id="w-weight" type="number" min="0" step="0.1" placeholder="Contoh: 5.2" class="mt-2 w-full px-4 py-4 rounded-xl border border-slate-200" />
        <label class="block text-slate-700 font-semibold mt-4">Tinggi Badan (cm)</label>
        <input id="w-height" type="number" min="0" step="0.1" placeholder="Contoh: 65.5" class="mt-2 w-full px-4 py-4 rounded-xl border border-slate-200" />
        <div class="mt-3 rounded-xl bg-slate-100 p-4 text-slate-600 text-sm">
          <div>Usia anak: <b id="w-age">-</b>
          </div>
          <div>IMT: <b id="w-bmi">-</b>
          </div>
          <div class="text-slate-500">Z-score WHO (BB/U, TB/U, IMT/U): <b id="w-z">-</b>
          </div>
        </div>
        <button id="w-save" class="btn btn-primary w-full mt-5">Simpan Penimbangan</button>
      </div>
    </section>
    <script>
      // --- MINIMAL AUTH (agar Logout & guard jalan) ---
      const AUTH = {
        KEY: 'session_user',
        loadSession() {
          try {
            return JSON.parse(localStorage.getItem(this.KEY) || 'null');
          } catch {
            return null;
          }
        },
        saveSession(obj) {
          localStorage.setItem(this.KEY, JSON.stringify(obj));
        },
        logout() {
          localStorage.removeItem(this.KEY);
          // bersihkan UI state ringan jika perlu
          document.querySelectorAll('[data-view]').forEach(v => v.classList.remove('active'));
          const login = document.getElementById('view-login') || document.getElementById('view-home'); // fallback ke home jika belum punya halaman login
          if (login) login.classList.add('active');
        }
      };
      // ---- PERSIST DB ke localStorage ----
      const DB_KEY = 'imunisasi_db_v1';

      function saveDB() {
        try {
          localStorage.setItem(DB_KEY, JSON.stringify(DB));
        } catch (e) {}
      }

      function loadDB() {
        try {
          const raw = localStorage.getItem(DB_KEY);
          if (raw) {
            const parsed = JSON.parse(raw);
            if (parsed.children) DB.children = parsed.children;
            if (parsed.batches) DB.batches = parsed.batches;
          }
        } catch (e) {}
      }
      // (opsional) refresh list kalau halaman list sedang terbuka
      function refreshListIfVisible() {
        const v = document.getElementById('view-list');
        if (v && v.classList.contains('active')) renderChildList();
      }
      // --- GANTI nav(view) lama dengan ini ---
      // === LOGIN wiring ===
      (function wireLogin() {
        const btn = document.getElementById('btnLogin');
        if (!btn) return;
        btn.addEventListener('click', () => {
          const u = document.getElementById('login-username').value.trim();
          const p = document.getElementById('login-password').value;
          const err = document.getElementById('login-error');
          // kredensial dummy
          const OK_USER = 'petugas';
          const OK_PASS = '123456';
          if (u === OK_USER && p === OK_PASS) {
            AUTH.saveSession({
              username: u,
              loginAt: Date.now()
            });
            if (err) err.classList.add('hidden');
            updateAuthUI(true);
            nav('hub');
          } else {
            if (err) err.classList.remove('hidden');
          }
        });
      })();
      // Buat kartu bisa di-klik dan pakai keyboard
      function makeCardLink(id, handler) {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('click', handler);
        el.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            handler();
          }
        });
      }
      // Arahkan ke halaman yang sesuai
      makeCardLink('cardGoImmunize', () => {
        // pakai halaman input NIK yang sudah ada
        nav('home');
      });
      makeCardLink('cardGoList', () => {
        openList(); // <- ini akan nav('list') + renderChildList() + wiring input
      });

      function nav(view) {
        // kalau kamu belum punya halaman login, guard ini aman-aman aja (akan jatuh ke view yg diminta)
        const hasLoginView = !!document.getElementById('view-login');
        if (hasLoginView && view !== 'login' && !AUTH.loadSession()) {
          document.querySelectorAll('[data-view]').forEach(v => v.classList.remove('active'));
          document.getElementById('view-login').classList.add('active');
          return;
        }
        document.querySelectorAll('[data-view]').forEach(v => v.classList.remove('active'));
        const target = document.getElementById(`view-${view}`);
        if (target) {
          target.classList.add('active');
          if (view === 'list') renderChildList(); // jaga-jaga: render saat view list aktif
        }
      }

      function updateAuthUI(isLoggedIn = !!AUTH.loadSession()) {
        const btnLogout = document.getElementById('btnLogout');
        if (btnLogout) {
          btnLogout.style.display = isLoggedIn ? '' : 'none';
        }
      }
      // Patch AUTH.logout agar sekalian sembunyikan tombol:
      AUTH.logout = function() {
        localStorage.removeItem(this.KEY);
        document.querySelectorAll('[data-view]').forEach(v => v.classList.remove('active'));
        const login = document.getElementById('view-login') || document.getElementById('view-home');
        if (login) {
          login.classList.add('active');
          login.style.removeProperty('display'); // jaga-jaga
        }
        updateAuthUI(false);
      };
      // ====== DB MOCK ======
      const DB = {
        children: {
          '3574015706250002': {
            nik: '3574015706250002',
            name: 'Bambang',
            parent: 'Bambang Sr',
            dob: '2025-07-06',
            sex: 'M',
            records: {
              bcg1: '2025-06-17'
            },
            measures: [],
            isStudentSD: false
          }
        },
        batches: {
          bcg1: [{
            code: 'BCG-A01',
            exp: '2026-12-31',
            active: true,
            dosesRemaining: 10
          }, {
            code: 'BCG-B02',
            exp: '2025-05-30',
            active: false,
            dosesRemaining: 0
          }],
          hb0_1: [{
            code: 'HBO-771',
            exp: '2025-11-15',
            active: true,
            dosesRemaining: 3
          }],
          opv1: [{
            code: 'OPV-992',
            exp: '2026-04-01',
            active: true,
            dosesRemaining: 8
          }],
          opv2: [{
            code: 'OPV-992',
            exp: '2026-04-01',
            active: true,
            dosesRemaining: 8
          }],
          opv3: [{
            code: 'OPV-992',
            exp: '2026-04-01',
            active: true,
            dosesRemaining: 8
          }],
          opv4: [{
            code: 'OPV-992',
            exp: '2026-04-01',
            active: true,
            dosesRemaining: 8
          }],
          pentabio1: [{
            code: 'PENTA-55',
            exp: '2025-12-30',
            active: true,
            dosesRemaining: 5
          }],
          pentabio2: [{
            code: 'PENTA-55',
            exp: '2025-12-30',
            active: true,
            dosesRemaining: 5
          }],
          pentabio3: [{
            code: 'PENTA-55',
            exp: '2025-12-30',
            active: true,
            dosesRemaining: 5
          }],
          pcv1: [{
            code: 'PCV-101',
            exp: '2026-03-01',
            active: true,
            dosesRemaining: 6
          }],
          pcv2: [{
            code: 'PCV-101',
            exp: '2026-03-01',
            active: true,
            dosesRemaining: 6
          }],
          rota1: [{
            code: 'ROTA-77',
            exp: '2025-10-30',
            active: true,
            dosesRemaining: 2
          }],
          ipv1: [{
            code: 'IPV-33',
            exp: '2026-05-05',
            active: true,
            dosesRemaining: 4
          }],
          pentabio4: [{
            code: 'PENTA-99',
            exp: '2026-12-31',
            active: true,
            dosesRemaining: 8
          }],
          rota2: [{
            code: 'ROTA-78',
            exp: '2026-10-30',
            active: true,
            dosesRemaining: 5
          }],
          rota3: [{
            code: 'ROTA-79',
            exp: '2026-12-30',
            active: true,
            dosesRemaining: 5
          }],
          pcv3: [{
            code: 'PCV-202',
            exp: '2027-03-01',
            active: true,
            dosesRemaining: 6
          }],
          ipv2: [{
            code: 'IPV-44',
            exp: '2027-05-05',
            active: true,
            dosesRemaining: 4
          }],
          mr1: [{
            code: 'MR-091',
            exp: '2027-01-31',
            active: true,
            dosesRemaining: 12
          }],
          mr2: [{
            code: 'MR-182',
            exp: '2027-02-28',
            active: true,
            dosesRemaining: 10
          }],
          je1: [{
            code: 'JE-001',
            exp: '2027-08-31',
            active: true,
            dosesRemaining: 8
          }],
          mr_school: [{
            code: 'MR-SCH',
            exp: '2028-06-30',
            active: true,
            dosesRemaining: 50
          }],
          dt_school: [{
            code: 'DT-SCH',
            exp: '2028-06-30',
            active: true,
            dosesRemaining: 50
          }],
          td_school_2: [{
            code: 'TD-CLS2',
            exp: '2028-06-30',
            active: true,
            dosesRemaining: 50
          }],
          td_school_5: [{
            code: 'TD-CLS5',
            exp: '2028-06-30',
            active: true,
            dosesRemaining: 50
          }],
          hpv_kls5: [{
            code: 'HPV-5F',
            exp: '2028-12-31',
            active: true,
            dosesRemaining: 50
          }]
        }
      };
      loadDB();
      // ====== RULES (disingkat) ======
      const RULES = [
        // RUTIN — Bayi/BBL/SI
        {
          id: 'hb0_1',
          label: 'Hepatitis B0 (HB0)',
          ideal: {
            hours: 24
          },
          notAfterDays: 7,
          catchupUntilDays: 7 // <-- baru: kejar sampai 7 hari dari lahir
        }, {
          id: 'bcg1',
          label: 'BCG',
          ideal: {
            months: 1
          },
          catchupUntilMonths: 11,
          notAfterYears: 1
        },
        // OPV (0–4 bln), kejar s.d 59 bln
        {
          id: 'opv1',
          label: 'Polio (OPV) – Dosis 1',
          ideal: {
            months: 1
          },
          catchupUntilMonths: 59,
          notAfterYears: 5
        }, {
          id: 'opv2',
          label: 'Polio (OPV) – Dosis 2',
          ideal: {
            months: 2
          },
          catchupUntilMonths: 59,
          notAfterYears: 5
        }, {
          id: 'opv3',
          label: 'Polio (OPV) – Dosis 3',
          ideal: {
            months: 3
          },
          catchupUntilMonths: 59,
          notAfterYears: 5
        }, {
          id: 'opv4',
          label: 'Polio (OPV) – Dosis 4',
          ideal: {
            months: 4
          },
          catchupUntilMonths: 59,
          notAfterYears: 5
        },
        // DPT–HB–Hib (Pentabio) 1–3 (2,3,4 bln), kejar s.d 59 bln
        {
          id: 'pentabio1',
          label: 'DPT–HB–Hib (Pentabio) – Dosis 1',
          ideal: {
            months: 2
          },
          catchupUntilMonths: 59,
          notAfterYears: 5
        }, {
          id: 'pentabio2',
          label: 'DPT–HB–Hib (Pentabio) – Dosis 2',
          ideal: {
            months: 3
          },
          catchupUntilMonths: 59,
          notAfterYears: 5
        }, {
          id: 'pentabio3',
          label: 'DPT–HB–Hib (Pentabio) – Dosis 3',
          ideal: {
            months: 4
          },
          catchupUntilMonths: 59,
          notAfterYears: 5
        },
        // Rotavirus 1–3 (2,3,4 bln) — maksimum < 7 bln(tidak boleh setelah 7 bln)
        // Rotavirus: kejar sampai < 7 bulan - > interpret as 6 months + 29 days 
        {
          id: 'rota1',
          label: 'Rotavirus – Dosis 1',
          ideal: {
            months: 2
          },
          catchupUntilMonths: 6,
          notAfterMonths: 7
        }, {
          id: 'rota2',
          label: 'Rotavirus – Dosis 2',
          ideal: {
            months: 3
          },
          catchupUntilMonths: 6,
          notAfterMonths: 7
        }, {
          id: 'rota3',
          label: 'Rotavirus – Dosis 3',
          ideal: {
            months: 4
          },
          catchupUntilMonths: 6,
          notAfterMonths: 7
        },
        // PCV 1–2 (2,3 bln) + PCV 3 (12 bln)
        {
          id: 'pcv1',
          label: 'PCV – Dosis 1',
          ideal: {
            months: 2
          },
          catchupUntilMonths: 59,
          notAfterYears: 5
        }, {
          id: 'pcv2',
          label: 'PCV – Dosis 2',
          ideal: {
            months: 3
          },
          catchupUntilMonths: 59,
          notAfterYears: 5
        }, {
          id: 'pcv3',
          label: 'PCV – Dosis 3',
          ideal: {
            months: 12
          }
        },
        // IPV 1 (4 bln) + IPV 2 (9 bln) — kejar s.d ≥5 th tidak diberikan
        {
          id: 'ipv1',
          label: 'IPV – Dosis 1',
          ideal: {
            months: 4
          },
          notAfterYears: 5
        }, {
          id: 'ipv2',
          label: 'IPV – Dosis 2',
          ideal: {
            months: 9
          },
          notAfterYears: 5
        },
        // MR1 (9 bln) kejar s.d 59 bln
        {
          id: 'mr1',
          label: 'Campak Rubella/MR – Dosis 1',
          ideal: {
            months: 9
          },
          catchupUntilMonths: 59,
          notAfterYears: 5
        },
        // JE* (10 bln) — hanya daerah endemis (opsional)
        //{ id:'je1',       label:'JE* – Dosis 1 (daerah endemis)',                ideal:{months:10}, optional:true },
        // Baduta (≥18 bln)
        {
          id: 'pentabio4',
          label: 'DPT–HB–Hib (Pentabio) – Dosis 4 (Booster)',
          ideal: {
            months: 18
          }
        }, {
          id: 'mr2',
          label: 'Campak Rubella/MR – Dosis 2',
          ideal: {
            months: 18
          },
          notAfterYears: 5
        },
        // BIAS (Sekolah)
        {
          id: 'mr_school',
          label: 'MR (BIAS) – Kelas 1 (≈7 th)',
          ideal: {
            years: 7
          }
        }, {
          id: 'dt_school',
          label: 'DT (BIAS) – Kelas 1 (≈7 th)',
          ideal: {
            years: 7
          },
          minGapMonthsFrom: 'mr_school',
          minGapMonths: 6 /* catatan: berbeda program, gap min 6 bln */
        }, {
          id: 'td_school_2',
          label: 'Td (BIAS) – Kelas 2 (≈8 th)',
          ideal: {
            years: 8
          }
        }, {
          id: 'td_school_5',
          label: 'Td (BIAS) – Kelas 5 (≈11 th)',
          ideal: {
            years: 11
          }
        },
        // HPV (khusus siswi kelas 5) – tetap kita simpan agar UI mengenali
        {
          id: 'hpv_kls5',
          label: 'HPV (BIAS) – Kelas 5 (siswi)',
          ideal: {
            years: 11
          },
          girlsOnly: true
        }
      ];
      // Kelompok seri untuk validasi interval
      const SERIES = {
        opv: ['opv1', 'opv2', 'opv3', 'opv4'],
        pentabio: ['pentabio1', 'pentabio2', 'pentabio3', 'pentabio4'],
        pcv: ['pcv1', 'pcv2', 'pcv3'],
        rota: ['rota1', 'rota2', 'rota3'],
        mr: ['mr1', 'mr2'],
        ipv: ['ipv1', 'ipv2']
      };

      function seriesInfo(ruleId) {
        for (const [key, arr] of Object.entries(SERIES)) {
          const idx = arr.indexOf(ruleId);
          if (idx >= 0) return {
            key,
            arr,
            idx
          };
        }
        return null;
      }

      function seriesLabel(key) {
        return key === 'opv' ? 'OPV' : key === 'pentabio' ? 'DPT-HB-Hib (Pentabio)' : key === 'pcv' ? 'PCV' : key === 'rota' ? 'Rotavirus' : key === 'ipv' ? 'IPV' : 'Seri';
      }
      // Validasi interval antar dosis (>= 28 hari) dan urutan
      function validateInterval(ruleId, dateISO) {
        const info = seriesInfo(ruleId);
        if (!info) return {
          ok: true
        };
        if (info.idx === 0) return {
          ok: true
        };
        let prevDate = null;
        for (let k = info.idx - 1; k >= 0; k--) {
          const rid = info.arr[k];
          const rec = (currentChild && currentChild.records) ? currentChild.records[rid] : null;
          if (rec) {
            prevDate = (typeof rec === 'string') ? rec : rec.date;
            break;
          }
        }
        const label = seriesLabel(info.key);
        if (!prevDate) {
          return {
            ok: false,
            msg: `Tidak bisa menyimpan ${label} dosis ${info.idx+1} sebelum dosis ${info.idx} tercatat.`
          };
        }
        const gap = daysBetween(prevDate, dateISO);
        if (!isFinite(gap)) {
          return {
            ok: false,
            msg: `Tanggal tidak valid. Mohon cek kembali.`
          };
        }
        if (gap < 28) {
          return {
            ok: false,
            msg: `Interval antar dosis ${label} minimal 4 minggu (28 hari).\nJarak dari dosis sebelumnya: ${gap} hari.\nDosis sebelumnya: ${fmtID(prevDate)} · Tanggal input: ${fmtID(dateISO)}`
          };
        }
        // Additional age-dependent rules for Pentabio (DPT-HB-Hib)
        if (info.key === 'pentabio') {
          // compute child's age in months at the date of the new dose
          const age = diffYMD(currentChild.dob, dateISO);
          const ageMonths = age.years * 12 + age.months;
          if (ageMonths >= 12 && ageMonths <= 59) {
            // Instead of day-count heuristics, derive calendar-based minimal allowed date
            // Find the previous dose index and its date (prevDate already set)
            let minAllowed = null;
            if (info.idx === 1) { // dose 2: min 1 month after prevDate
              minAllowed = addUTC(prevDate, {
                months: 1
              });
            }
            if (info.idx === 2) { // dose 3: min 6 months after prevDate
              minAllowed = addUTC(prevDate, {
                months: 6
              });
            }
            if (info.idx === 3) { // dose 4: min 12 months after prevDate
              minAllowed = addUTC(prevDate, {
                months: 12
              });
            }
            if (minAllowed && dateISO < minAllowed) {
              return {
                ok: false,
                msg: `Untuk usia 12-59 bulan, tanggal minimal untuk dosis ini adalah ${fmtID(minAllowed)} (aturan: lihat catatan program).`
              };
            }
          }
        }
        // PCV rules: if child age 12-24 months and saving dose 2, require >=8 weeks (56 days) from dose1
        if (info.key === 'pcv') {
          const age = diffYMD(currentChild.dob, dateISO);
          const ageMonths = age.years * 12 + age.months;
          if (ageMonths >= 12 && ageMonths < 24 && info.idx === 1) {
            const minDate = addUTC(prevDate, {
              days: 56
            });
            if (dateISO < minDate) return {
              ok: false,
              msg: `Untuk usia 12-24 bulan, PCV dosis 2 minimal 8 minggu setelah dosis 1 (minimal tanggal ${fmtID(minDate)}).`
            };
          }
        }
        // MR rules: second MR dose (idx 1) must be at least 6 months after first
        if (info.key === 'mr') {
          if (info.idx === 1) {
            const minDate = addUTC(prevDate, {
              months: 6
            });
            if (dateISO < minDate) return {
              ok: false,
              msg: `MR dosis 2 harus minimal 6 bulan setelah MR dosis 1 (minimal tanggal ${fmtID(minDate)}).`
            };
          }
        }
        return {
          ok: true
        };
      }

      function earliestAllowedDate(rule) {
        var idealDate = idealDateFor(rule, currentChild.dob);
        return (currentChild.dob > idealDate) ? currentChild.dob : idealDate;
      }

      function validateDateWindow(ruleId, dateISO) {
        const rule = RULES.find(r => r.id === ruleId);
        if (!rule) return {
          ok: true
        };
        const minDate = earliestAllowedDate(rule);
        if (dateISO < currentChild.dob) {
          return {
            ok: false,
            msg: `Tanggal tidak boleh sebelum tanggal lahir (${fmtID(currentChild.dob)}).`
          };
        }
        if (dateISO < minDate) {
          return {
            ok: false,
            msg: `Tanggal tidak boleh sebelum jadwal ideal (${fmtID(minDate)}).`
          };
        }
        // Batas maksimum usia (opsional per tabel)
        const add = (iso, {
          years = 0,
          months = 0,
          days = 0
        }) => {
          // operate in UTC to avoid timezone shifts
          const d = _dUTC(iso);
          d.setUTCFullYear(d.getUTCFullYear() + years);
          d.setUTCMonth(d.getUTCMonth() + months);
          d.setUTCDate(d.getUTCDate() + days);
          return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate())).toISOString().slice(0, 10);
        };
        // notAfterDays (sudah dipakai HBo)
        if (rule.notAfterDays) {
          const maxD = add(currentChild.dob, {
            days: rule.notAfterDays
          });
          if (dateISO > maxD) return {
            ok: false,
            msg: `Melewati batas maksimum (${rule.notAfterDays} hari dari lahir).`
          };
        }
        // notAfterMonths / Years
        if (rule.notAfterMonths) {
          const maxM = addUTC(currentChild.dob, {
            months: rule.notAfterMonths
          });
          if (dateISO > maxM) return {
            ok: false,
            msg: `Melewati batas maksimum usia (${rule.notAfterMonths} bulan).`
          };
        }
        if (rule.notAfterYears) {
          const maxY = add(currentChild.dob, {
            years: rule.notAfterYears
          });
          if (dateISO > maxY) return {
            ok: false,
            msg: `Melewati batas maksimum usia (${rule.notAfterYears} tahun).`
          };
        }
        // catchupUntilMonths (boleh sampai X bulan; setelah itu ditolak)
        if (rule.catchupUntilMonths) {
          // kejar sampai N months + 29 days (mis. 11 months + 29 days)
          const maxC = addUTC(currentChild.dob, {
            months: rule.catchupUntilMonths,
            days: 29
          });
          if (dateISO > maxC) return {
            ok: false,
            msg: `Melewati batas kejar (${rule.catchupUntilMonths} bulan + 29 hari).`
          };
        }
        return {
          ok: true
        };
      }
      const MS_DAY = 24 * 60 * 60 * 1000;

      function daysBetween(aISO, bISO) {
        return Math.floor((_dUTC(bISO) - _dUTC(aISO)) / MS_DAY);
      }
      // ====== UTIL ======
      const byId = id => document.getElementById(id);
      const todayISO = () => new Date().toISOString().slice(0, 10);
      const fmtID = iso => new Date(iso + 'T00:00:00').toLocaleDateString('id-ID', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      });

      function addMonths(iso, m) {
        const d = new Date(iso + 'T00:00:00');
        const day = d.getDate();
        d.setMonth(d.getMonth() + m);
        if (d.getDate() < day) d.setDate(0);
        return d.toISOString().slice(0, 10);
      }

      function addDays(iso, n) {
        const d = new Date(iso + 'T00:00:00');
        d.setDate(d.getDate() + n);
        return d.toISOString().slice(0, 10);
      }

      function addDaysUTC(iso, n) {
        const d = _dUTC(iso);
        d.setUTCDate(d.getUTCDate() + n);
        return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate())).toISOString().slice(0, 10);
      }

      function _dUTC(iso) {
        const [y, m, d] = iso.split('-').map(Number);
        return new Date(Date.UTC(y, m - 1, d));
      }
      // Add/shift date in UTC by years/months/days and return YYYY-MM-DD
      function addUTC(iso, {
        years = 0,
        months = 0,
        days = 0
      } = {}) {
        const d = _dUTC(iso);
        d.setUTCFullYear(d.getUTCFullYear() + years);
        d.setUTCMonth(d.getUTCMonth() + months);
        d.setUTCDate(d.getUTCDate() + days);
        return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate())).toISOString().slice(0, 10);
      }

      function daysInMonthUTC(y, m) {
        return new Date(Date.UTC(y, m + 1, 0)).getUTCDate();
      }

      function addMonthsClampUTC(date, months) {
        let y = date.getUTCFullYear(),
          m = date.getUTCMonth(),
          d = date.getUTCDate();
        m += months;
        y += Math.floor(m / 12);
        m = (m % 12 + 12) % 12;
        const dim = daysInMonthUTC(y, m);
        const dd = Math.min(d, dim);
        return new Date(Date.UTC(y, m, dd));
      }

      function diffYMD(fromISO, toISO) {
        const a = _dUTC(fromISO),
          b = _dUTC(toISO);
        if (b < a) return {
          years: 0,
          months: 0,
          days: 0
        };
        let totalMonths = (b.getUTCFullYear() - a.getUTCFullYear()) * 12 + (b.getUTCMonth() - a.getUTCMonth());
        if (b.getUTCDate() < a.getUTCDate()) totalMonths -= 1;
        const years = Math.floor(totalMonths / 12);
        const months = totalMonths % 12;
        const anchor = addMonthsClampUTC(a, totalMonths);
        const MS = 24 * 60 * 60 * 1000;
        const days = Math.floor((b - anchor) / MS);
        return {
          years,
          months,
          days
        };
      }

      function parseDOBFromNIK(nik) {
        if (!/^[0-9]{16}$/.test(nik)) return null;
        const dd = parseInt(nik.slice(6, 8), 10);
        const mm = parseInt(nik.slice(8, 10), 10);
        const yy = parseInt(nik.slice(10, 12), 10);
        const female = dd > 40;
        const day = female ? dd - 40 : dd;
        const now = new Date();
        const curYY = now.getFullYear() % 100;
        const fullYear = (yy <= curYY ? 2000 + yy : 1900 + yy);
        const pad = n => String(n).padStart(2, '0');
        return `${fullYear}-${pad(mm)}-${pad(day)}`;
      }

      function sexFromNIK(nik) {
        if (!/^[0-9]{16}$/.test(nik)) return 'M';
        const dd = parseInt(nik.slice(6, 8), 10);
        return dd > 40 ? 'F' : 'M';
      }

      function ageLabel(dob, ref = todayISO()) {
        const {
          years,
          months,
          days
        } = diffYMD(dob, ref);
        return `${years} tahun ${months} bulan ${days} hari`;
      }
      // ====== NAV + HOME ======
      byId('nikInput').addEventListener('input', e => {
        byId('nikCount').textContent = e.target.value.length;
      });
      byId('btnCari').addEventListener('click', () => {
        const nik = byId('nikInput').value.trim();
        if (nik.length !== 16) {
          alert('NIK harus 16 digit.');
          return;
        }
        if (DB.children[nik]) {
          openChild(nik);
        } else {
          openRegister(nik);
        }
      });
      // byId('btnTambahBaru').addEventListener('click',()=>{ const nik=byId('nikInput').value.padEnd(16,'0').slice(0,16); openRegister(nik); });
      // === HUB wiring ===
      // (function wireHub() {
      //   const a = document.getElementById('btnGoImmunize');
      //   const b = document.getElementById('btnGoList');
      //   if (a) a.onclick = () => nav('home'); // catat imunisasi = halaman NIK
      //   if (b) b.onclick = () => openList(); // daftar anak
      // })();
      // ====== REGISTER ======
      function openRegister(nik) {
        nav('register');
        byId('reg-nik').textContent = `NIK: ${nik}`;
        const dobFromNik = parseDOBFromNIK(nik);
        byId('reg-dob').value = dobFromNik || '';
        byId('reg-usia').textContent = dobFromNik ? `Usia: ${ageLabel(dobFromNik)}` : 'Usia: -';
        byId('reg-sex').value = sexFromNIK(nik);
        byId('reg-dob').oninput = () => {
          const v = byId('reg-dob').value;
          byId('reg-usia').textContent = v ? `Usia: ${ageLabel(v)}` : 'Usia: -';
        };
        byId('btnSimpanReg').onclick = () => {
          const name = byId('reg-name').value.trim();
          const dob = byId('reg-dob').value;
          const parent = byId('reg-parent').value.trim();
          const sex = byId('reg-sex').value;
          if (!name || !dob || !parent) {
            alert('Lengkapi semua data.');
            return;
          }
          DB.children[nik] = {
            nik,
            name,
            parent,
            dob,
            sex,
            records: {},
            measures: [],
            isStudentSD: false
          };
          saveDB();
          openChild(nik);
        };
      }
      // ====== CHILD ======
      let currentChild = null;

      function openChild(nik) {
  currentChild = DB.children[nik];
  nav('child');
  renderChildHeader();
  initTabs();                  // <-- baru
  renderProgramChips();
  renderVaxList();
  renderMeasureList();
  byId('btnAddMeasure').onclick = () => openWeigh('visit');
}


     function renderChildHeader() {
  const c = currentChild;
  const sexLabel = c.sex === 'F' ? 'Perempuan' : 'Laki-laki';
  byId('c-name').textContent   = c.name || '-';
  byId('c-nik').textContent    = c.nik || '-';
  byId('c-sex').textContent    = sexLabel;
  byId('c-dob').textContent    = c.dob ? new Date(c.dob+'T00:00:00').toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'}).toUpperCase() : '-';
  byId('c-age').textContent    = ageLabel(c.dob);
  byId('c-parent').textContent = c.parent || '-';
}
// Tab wiring
function initTabs() {
  const btnIm = byId('tab-btn-imun');
  const btnWe = byId('tab-btn-weigh');
  const pIm   = byId('tab-panel-imun');
  const pWe   = byId('tab-panel-weigh');
  if (!btnIm || !btnWe) return;

  const activate = (who) => {
    const a = who === 'imun';
    btnIm.classList.toggle('text-indigo-700', a);
    btnIm.classList.toggle('border-indigo-600', a);
    btnIm.classList.toggle('text-slate-500', !a);
    btnIm.classList.toggle('border-transparent', !a);

    btnWe.classList.toggle('text-indigo-700', !a);
    btnWe.classList.toggle('border-indigo-600', !a);
    btnWe.classList.toggle('text-slate-500', a);
    btnWe.classList.toggle('border-transparent', a);

    pIm.classList.toggle('hidden', !a);
    pIm.classList.toggle('block', a);
    pWe.classList.toggle('hidden', a);
    pWe.classList.toggle('block', !a);
  };
  btnIm.onclick = () => activate('imun');
  btnWe.onclick = () => activate('weigh');
  activate('imun'); // default
}



      function idealDateFor(rule, dob) {
        if (rule.ideal?.hours) {
          return dob;
        }
        const months = rule.ideal?.months || 0;
        const years = rule.ideal?.years ? rule.ideal.years * 12 : 0;
        return addMonths(dob, months + years);
      }
      // Ideal + 29 hari dianggap masih "on-time" untuk jadwal berbasis bulan/tahun.
      // HB0 (ideal.hours) TIDAK mendapat grace.
      function idealGraceEnd(rule, dob) {
        if (rule.ideal?.hours) {
          // HB0: Jadwal Ideal jika H (DOB) atau H+1
          return addDaysUTC(dob, 1);
        }
        const baseIdeal = idealDateFor(rule, dob);
        return addDaysUTC(baseIdeal, 29);
      }

      function statusFor(rule) {
        const rec = currentChild.records[rule.id];
        // explicit "Tidak Diberikan"
        if (rec && typeof rec === 'object' && rec.notGiven) {
          return {
            type: 'not_given',
            text: 'Tidak Diberikan'
          };
        }
        // --- Jika sudah ada tanggal tercatat ---
        if (rec) {
          const date = (typeof rec === 'string') ? rec : rec.date;
          const batch = (typeof rec === 'object') ? rec.batch : undefined;
          var idealDate = idealDateFor(rule, currentChild.dob);
          const graceEnd = idealGraceEnd(rule, currentChild.dob); // <<— baru
          // Selama masih dalam jendela ideal (+29 hari untuk jadwal berbasis bulan/tahun),
          // hitung sebagai "on-time" (bukan kejar)
          if (date <= graceEnd) {
            return {
              type: 'ideal',
              text: 'Jadwal Ideal',
              date,
              batch
            };
          }
          // Di atas ideal (setelah grace) — periksa jendela kejar/maksimum
          let catchupEnd = null;
          // <-- TAMBAHAN: window kejar berbasis hari (khusus HB0)
          if (rule.catchupUntilDays) {
            catchupEnd = addDaysUTC(currentChild.dob, rule.catchupUntilDays);
          }
          if (rule.catchupUntilMonths) {
            catchupEnd = addUTC(currentChild.dob, {
              months: rule.catchupUntilMonths,
              days: 29
            });
          }
          if (rule.notAfterMonths) {
            catchupEnd = addUTC(currentChild.dob, {
              months: rule.notAfterMonths
            });
          }
          if (rule.notAfterYears) {
            catchupEnd = addUTC(currentChild.dob, {
              months: rule.notAfterYears * 12
            });
          }
          if (catchupEnd) {
            if (date <= catchupEnd) return {
              type: 'kejar',
              text: 'Kejar',
              date,
              batch
            };
            // lewat jendela kejar: tetap ditandai selesai (telat), UI tetap "Selesai"
            return {
              type: 'ideal',
              text: 'Jadwal Ideal',
              date,
              batch
            };
          }
          // tak ada definisi kejar → anggap selesai
          return {
            type: 'ideal',
            text: 'Jadwal Ideal',
            date,
            batch
          };
        }
        // --- (sisanya tetap seperti semula) ---
        const today = todayISO();
        var idealDate = idealDateFor(rule, currentChild.dob);
        // HB0: jendela pendek berbasis hari
        if (rule.ideal?.hours) {
          const max = addDaysUTC(currentChild.dob, (rule.notAfterDays ?? 7));
          if (today < idealDate) return {
            type: 'hidden'
          };
          if (today <= max) return {
            type: 'due',
            text: 'Belum Dicatat - Sesuai Jadwal'
          };
          return {
            type: 'late',
            text: 'Belum Dicatat'
          };
        }
        // Vaksin berbasis bulan/tahun:
        // sebelum ideal → hidden; ideal..ideal+29 → due; >ideal+29 → late
        const graceEnd = addDaysUTC(idealDate, 29); // sudah ada sebelumnya—tetap dipakai
        if (today > graceEnd) return {
          type: 'late',
          text: 'Terlambat'
        };
        if (today < idealDate) return {
          type: 'hidden'
        };
        return {
          type: 'due',
          text: 'Sesuai Jadwal'
        };
      }

      function badge(st) {
        if (!st) return '';
        switch (st.type) {
          case 'ideal':
            return `
              <span class="badge b-green">${st.text || 'Jadwal Ideal'}</span>`;
          case 'kejar':
            return `<span class="badge b-amber">Jadwal Kejar</span>`;
          case 'due':
            return `
              <span class="badge b-amber">Belum Dicatat</span>`;
          case 'late':
            return `
              <span class="badge b-red">Belum Dicatat</span>`;
          case 'not_given':
            return `
              <span class="badge b-slate">Tidak Diberikan</span>`;
          default:
            return '';
        }
      }

      function fillBatchOptions(selectEl, vaxId) {
        selectEl.innerHTML = '';
        const arr = DB.batches[vaxId] || [];
        const now = todayISO();
        arr.forEach(b => {
          const disabled = !b.active || b.dosesRemaining <= 0 || b.exp < now;
          const opt = document.createElement('option');
          opt.value = b.code;
          opt.textContent = `${b.code} · exp ${fmtID(b.exp)}` + (!b.active ? ' · non-aktif' : '') + (b.exp < now ? ' · expired' : '');
          opt.disabled = disabled;
          selectEl.appendChild(opt);
        });
        if (selectEl.options.length === 0) {
          const o = document.createElement('option');
          o.textContent = 'Tidak ada batch tersedia';
          selectEl.appendChild(o);
        }
      }
      // ====== COMPLETENESS CHIPS (dummy evaluasi cepat) ======
      // === Helper status per-antigen & paket ===
      // 3 keadaan: 'PENDING' | 'DONE' | 'NOT_GIVEN'
      function antigenState(id) {
        const r = (currentChild?.records || {})[id];
        if (!r) return 'PENDING';
        if (typeof r === 'object' && r.notGiven) return 'NOT_GIVEN';
        return 'DONE';
      }
      // Ambil tanggal jika DONE (bisa string atau object {date})
      function antigenDate(id) {
        const r = (currentChild?.records || {})[id];
        if (!r) return null;
        return (typeof r === 'string') ? r : r.date || null;
      }
      // Cek apakah tanggal DONE berada di jendela IDL (0–11 bln + 29 hari)
      function inIDLWindow(dateISO) {
        if (!dateISO) return false;
        const end = addUTC(currentChild.dob, {
          months: 11,
          days: 29
        });
        return dateISO >= currentChild.dob && dateISO <= end;
      }
      // Cek apakah tanggal DONE berada di jendela IBL (12–23 bln + 29 hari)
      function inIBLWindow(dateISO) {
        if (!dateISO) return false;
        const start = addUTC(currentChild.dob, {
          months: 12
        });
        const end = addUTC(currentChild.dob, {
          months: 23,
          days: 29
        });
        return dateISO >= start && dateISO <= end;
      }
      /**
       * Evaluasi satu paket → 'YES' | 'NO' | 'PENDING'
       * opts:
       *  - needsWindow: 'IDL' | 'IBL' | null
       *  - requires: () => 'YES' | 'NO' | 'PENDING'   (dependensi paket lain)
       */
      function evalPackage(ids, opts = {}) {
        let allResolved = true;
        let anyNotGiven = false;
        let allInWindow = true;
        for (const id of ids) {
          const st = antigenState(id);
          if (st === 'PENDING') allResolved = false;
          if (st === 'NOT_GIVEN') anyNotGiven = true;
          if (st === 'DONE' && opts.needsWindow) {
            const d = antigenDate(id);
            if (opts.needsWindow === 'IDL' && !inIDLWindow(d)) allInWindow = false;
            if (opts.needsWindow === 'IBL' && !inIBLWindow(d)) allInWindow = false;
          }
        }
        if (!allResolved) return 'PENDING'; // masih ada antigen yang belum dicatat sama sekali
        if (anyNotGiven) return 'NO'; // permintaanmu: kalau ada NOT_GIVEN → paket = TIDAK
        if (!allInWindow) {
  if (opts.needsWindow) {
    const now = todayISO();
    let end = null;
    if (opts.needsWindow === 'IDL') end = addUTC(currentChild.dob, { months: 11, days: 29 });
    if (opts.needsWindow === 'IBL') end = addUTC(currentChild.dob, { months: 23, days: 29 });
    if (end && now > end) return 'NO_PAST';
  }
  return 'NO';
}
 // DONE tapi di luar jendela paket → TIDAK
        if (typeof opts.requires === 'function' && opts.requires() !== 'YES') return 'NO';
        return 'YES';
      }

      function renderProgramChips() {
  // daftar antigen per paket
        const idlList  = ['hb0_1','bcg1','opv1','opv2','opv3','opv4','pentabio1','pentabio2','pentabio3','ipv1','mr1'];
        const iblList  = ['pentabio4','mr2'];
        const biasList = ['mr_school','dt_school','td_school_2','td_school_5'];
        const irlList  = ['td_school_5'];

  // hitung state per paket
        const idlState  = evalPackage(idlList,  { needsWindow:'IDL' });
        const iblState  = evalPackage(iblList,  { needsWindow:'IBL', requires: ()=>idlState });
  const biasState = evalPackage(biasList, { /* tanpa window usia */ });
        const irlState  = evalPackage(irlList,  { requires: ()=>biasState });

  // helper set chip
        const setChip = (chipId, state) => {
          const el = byId(chipId);
          if (!el) return;
          const row = el.parentElement;

    // Tampilkan baris hanya jika YES atau NO_PAST (gagal karena usia paket sudah lewat)
          if (state === 'YES' || state === 'NO_PAST') {
            row.style.display = '';
          } else {
      row.style.display = 'none';       // PENDING / NO (belum waktunya) disembunyikan
    }

    if (state === 'YES') {
      el.textContent = 'Ya';
      el.className = 'badge b-green';
    } else {
      // NO_PAST dirender “Tidak” (kuning) agar terlihat kenapa kartu tetap muncul
      el.textContent = 'Tidak';
      el.className = 'badge b-amber';
    }
  };

  setChip('chip-idl',  idlState);
  setChip('chip-ibl',  iblState);
  setChip('chip-bias', biasState);
  setChip('chip-irl',  irlState);

  // Tampilkan kartu bila minimal ada 1 paket YES atau NO_PAST
  const progWrap = byId('program-completeness');
  if (progWrap) {
    const states = [idlState, iblState, biasState, irlState];
    const show = states.some(s => s === 'YES' || s === 'NO_PAST');
    progWrap.style.display = show ? '' : 'none';
  }
} //  <<— penting: kurung penutup sebelum “LIST VAKSIN”

      // ====== LIST VAKSIN ======
      function renderVaxList() {
        const list = byId('vax-list');
        list.innerHTML = '';
        let idealCount = 0,
          kejarCount = 0,
          pendingCount = 0,
          notGiven = 0;
        RULES.forEach(rule => {
          const st = statusFor(rule);
          if (st.type === 'ideal') {
            idealCount++;
          } else if (st.type === 'kejar') {
            kejarCount++;
          } else if (st.type === 'due' || st.type === 'late') {
            pendingCount++;
          } else if (st.type === 'not_given') {
            notGiven++;
          }
          // record object (could be string date, object with date/batch, or {notGiven:true})
          const rec = currentChild.records[rule.id] || null;
          const hasRecord = Boolean(rec);
          // ❗ Sembunyikan antigen yang BELUM masuk jadwal ideal (status 'hidden')
          // selama belum ada catatan (tanggal / tidak diberikan).
          if (st.type === 'hidden' && !hasRecord) {
            return; // skip render untuk antigen ini
         }
          const hasDate = Boolean(st.date);
          var idealDate = idealDateFor(rule, currentChild.dob);
          const today = todayISO();
          // If today is within 30 days before OR after ideal (inclusive), batch input is required now
          const batchNow = (today >= addDaysUTC(idealDate, -30) && today <= addDaysUTC(idealDate, 30));
          const formId = `form-${rule.id}`;
          const row = document.createElement('div');
          row.className = 'px-5 py-4';
          row.innerHTML = `
      
                          
              <div class="flex items-start gap-3">
                <div class="min-w-0 flex-1">
                  <div class="flex items-center gap-3 flex-wrap">
                    <h3 class="font-medium text-slate-800">${rule.label}</h3>
            ${badge(st)}
          
                              
                  </div>
                  <p class="text-sm text-slate-500">Jadwal ideal: ${fmtID(idealDate)}</p>
          ${(()=>{
            // small rule hint: kejar end and interval summary
            let hints = [];
            if(rule.catchupUntilMonths){ const kejarEnd = addUTC(currentChild.dob,{months:rule.catchupUntilMonths,days:29}); hints.push(`
          Kejar sampai: $ {
            fmtID(kejarEnd)
          }
          `); }
            if(rule.notAfterMonths){ const na = addUTC(currentChild.dob,{months:rule.notAfterMonths}); hints.push(`
          Tidak boleh setelah: $ {
            fmtID(na)
          }
          `); }
            if(rule.notAfterYears){ const nay = addUTC(currentChild.dob,{years:rule.notAfterYears}); hints.push(`
          Tidak boleh setelah: $ {
            fmtID(nay)
          }
          `); }
            return '';
          })()}
          ${hasDate ? `
                              
                  <div class='text-sm text-slate-600 mt-1'>Tanggal penyuntikan: ${fmtID(st.date)}${st.batch?` · Batch: 
                                
                    <b>${st.batch}</b>`:''}
                              
                  </div>` : ''}
          
                            
                </div>
        ${(st.type==='ideal' || st.type==='not_given' || st.type==='kejar') ? `
                            
                <button class="btn btn-ghost text-sm" data-edit>Edit</button>` : ''}
      
                          
              </div>
              <!-- Input actions: tanggal / lengkap / tidak diberikan (only when not completed) -->
      ${(st.type==='ideal' || st.type==='not_given' || st.type==='kejar') ? '' : `
  
                          
              <div class="mt-3 grid grid-cols-3 gap-2">
    ${batchNow ? `` : `
                <button class="btn btn-ghost w-full" data-action="tanggal">Catat Tanggal Saja</button>`}
                            
                <button class="btn btn-primary w-full" data-action="lengkap">Catat dengan Batch</button>
                <a href="#" class="btn-text-link w-full" data-action="notgiven" title="Tidak Diberikan">Tidak Diberikan</a>
              </div>`}

      
                          
              <div id="${formId}" class="row-form mt-3">
                <div class="grid grid-cols-1 gap-3">
                  <div>
                    <label class="block text-sm text-slate-600">Tanggal Penyuntikan</label>
                    <input type="date" class="w-full px-4 py-3 rounded-xl border border-slate-200" />
                    <p class="mt-1 text-xs text-rose-600 hidden" data-error aria-live="polite"></p>
                  </div>
                  <!-- Toggle batch (muncul saat Edit) -->
                  <div class="batch-toggle hidden">
                    <label class="inline-flex items-center gap-2 text-sm text-slate-700">
                      <input type="checkbox" data-cbat class="rounded"> Catat batch (opsional)
            
                                  
                      </label>
                    </div>
                    <div class="batch-wrap hidden">
                      <label class="block text-sm text-slate-600">Batch</label>
                      <select class="w-full px-4 py-3 rounded-xl border border-slate-200"></select>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2">
                      <button class="btn btn-primary flex-1" data-save>Simpan</button>
            ${st.type==='due' ? '' : `
                                  
                      <a href="#" class="btn-text-link w-full sm:w-auto" data-notgiven title="Tidak Diberikan">Tidak Diberikan</a>`}
            
                                  
                      <button class="btn btn-ghost" data-cancel>Batal</button>
                    </div>
                  </div>
                </div>
           
    `;
          list.appendChild(row);
          // --- Wiring ---
          const form = row.querySelector(`#${formId}`);
          const dateInput = form.querySelector('input[type="date"]');
          var idealDate = idealDateFor(rule, currentChild.dob);
          const batchWrap = form.querySelector('.batch-wrap');
          const batchSelect = batchWrap.querySelector('select');
          const errEl = form.querySelector('[data-error]');
          const toggleWrap = form.querySelector('.batch-toggle');
          const cbAt = form.querySelector('[data-cbat]');
          const clearErr = () => {
            errEl.textContent = '';
            errEl.classList.add('hidden');
          }
          const undo = row.querySelector('[data-undo-notgiven]');
          if (undo) {
            undo.addEventListener('click', (e) => {
              e.preventDefault();
              // hapus catatan notGiven → kembali ke status belum dicatat
              delete currentChild.records[rule.id];
              saveDB();
              refreshListIfVisible();
              renderProgramChips();
              renderVaxList();
            });
          };
          // Default date = jadwal ideal (feedback)
          dateInput.value = idealDate;
          // Clamp ke minimal tanggal yang diizinkan
          const min = earliestAllowedDate(rule);
          dateInput.min = min;
          if (dateInput.value < min) dateInput.value = min;
          // NEW: Edit mode
          if (hasRecord) {
            toggleWrap.classList.remove('hidden');
            // Prefill dari record
            const r = currentChild.records[rule.id];
            const rDate = (typeof r === 'string') ? r : (r && r.date) || idealDate;
            const rBatch = (typeof r === 'object') ? r.batch : null;
            dateInput.value = rDate || idealDate;
            if (rBatch) {
              cbAt.checked = true;
              batchWrap.classList.remove('hidden');
              fillBatchOptions(batchSelect, rule.id);
              batchSelect.value = rBatch;
            }
            if (cbAt) {
              cbAt.addEventListener('change', () => {
                if (cbAt.checked) {
                  batchWrap.classList.remove('hidden');
                  fillBatchOptions(batchSelect, rule.id);
                } else {
                  batchWrap.classList.add('hidden');
                }
              });
            }
            const editBtn = row.querySelector('[data-edit]');
            if (editBtn) {
              editBtn.onclick = () => {
                form.classList.add('show');
                clearErr();
              };
            }
          } else {
            // Mode baru: dua tombol
            const btnTanggal = row.querySelector('[data-action="tanggal"]');
            const btnLengkap = row.querySelector('[data-action="lengkap"]');
            if (btnTanggal) {
              btnTanggal.onclick = () => {
                clearErr();
                // date-only path: prefill date, clamp to min; do NOT show batch
                dateInput.value = idealDate;
                const min = earliestAllowedDate(rule);
                dateInput.min = min;
                if (dateInput.value < min) dateInput.value = min;
                toggleWrap.classList.add('hidden');
                batchWrap.classList.add('hidden');
                if (cbAt) {
                  cbAt.checked = false;
                  cbAt.disabled = false;
                }
                form.classList.add('show');
              };
            }
            if (btnLengkap) {
              btnLengkap.onclick = () => {
                clearErr();
                form.classList.add('show');
                toggleWrap.classList.add('hidden');
                batchWrap.classList.remove('hidden');
                fillBatchOptions(batchSelect, rule.id);
                if (cbAt) cbAt.disabled = false;
              };
            }
          }
          // Ensure Edit button toggles form consistently for all statuses (done / not_given / kejar)
          const editBtn = row.querySelector('[data-edit]');
          if (editBtn) {
            editBtn.onclick = () => {
              // toggle: if visible, hide; else show and prepare fields
              if (form.classList.contains('show')) {
                form.classList.remove('show');
                return;
              }
              clearErr();
              // If there's an existing record, show batch toggle and prefill
              if (hasRecord) {
                toggleWrap.classList.remove('hidden');
                const r = currentChild.records[rule.id];
                const rDate = (typeof r === 'string') ? r : (r && r.date) || idealDate;
                const rBatch = (typeof r === 'object') ? r.batch : null;
                dateInput.value = rDate || idealDate;
                // init batch checkbox state
                if (cbAt) {
                  cbAt.checked = !!rBatch;
                }
                if (cbAt && cbAt.checked) {
                  batchWrap.classList.remove('hidden');
                  fillBatchOptions(batchSelect, rule.id);
                  batchSelect.value = rBatch || (batchSelect.options[0] && batchSelect.options[0].value);
                } else {
                  batchWrap.classList.add('hidden');
                }
              } else {
                // New entry / kejar case: decide batch visibility based on requirement
                const min = earliestAllowedDate(rule);
                dateInput.min = min;
                dateInput.value = idealDate;
                if (dateInput.value < min) dateInput.value = min;
                // If within 30 days before ideal, require batch
                const threshold = addDaysUTC(idealDate, -30);
                if (dateInput.value >= threshold && dateInput.value <= idealDate) {
                  toggleWrap.classList.add('hidden');
                  batchWrap.classList.remove('hidden');
                  fillBatchOptions(batchSelect, rule.id);
                  if (cbAt) {
                    cbAt.checked = true;
                    cbAt.disabled = true;
                  }
                } else {
                  toggleWrap.classList.add('hidden');
                  batchWrap.classList.add('hidden');
                  if (cbAt) {
                    cbAt.checked = false;
                    cbAt.disabled = false;
                  }
                }
              }
              // attach batch checkbox listener once
              if (cbAt && !cbAt._listenerAdded) {
                cbAt.addEventListener('change', () => {
                  if (cbAt.checked) {
                    batchWrap.classList.remove('hidden');
                    fillBatchOptions(batchSelect, rule.id);
                  } else {
                    batchWrap.classList.add('hidden');
                  }
                });
                cbAt._listenerAdded = true;
              }
              form.classList.add('show');
            };
          }
          // External 'Tidak Diberikan' button (next to input buttons)
          const btnNotGivenExt = row.querySelector('[data-action="notgiven"]');
          if (btnNotGivenExt) {
            btnNotGivenExt.addEventListener('click', (e) => {
              e.preventDefault();
              if (!confirm('Tandai vaksin ini sebagai TIDAK DIBERIKAN?\nIni akan menyimpan catatan bahwa vaksin tidak diberikan dan tidak dihitung pada kelengkapan.')) return;
              currentChild.records[rule.id] = {
                notGiven: true
              };
              saveDB();
              refreshListIfVisible();
              renderProgramChips();
              renderVaxList();
            });
          }
          form.querySelector('[data-cancel]').onclick = () => {
            form.classList.remove('show');
          };
          // Handle 'Tidak Diberikan' explicit action
          const btnNotGiven = form.querySelector('[data-notgiven]');
          if (btnNotGiven) {
            btnNotGiven.addEventListener('click', (e) => {
              e.preventDefault();
              if (!confirm('Tandai vaksin ini sebagai TIDAK DIBERIKAN?\nIni akan menyimpan catatan bahwa vaksin tidak diberikan dan tidak dihitung pada kelengkapan.')) return;
              currentChild.records[rule.id] = {
                notGiven: true
              };
              saveDB();
              refreshListIfVisible();
              renderProgramChips();
              renderVaxList();
            });
          }
          form.querySelector('[data-save]').onclick = () => {
            const d = dateInput.value;
            if (!d) {
              errEl.textContent = 'Isi tanggal terlebih dahulu.';
              errEl.classList.remove('hidden');
              return;
            }
            const w = validateDateWindow(rule.id, d);
            if (!w.ok) {
              errEl.textContent = w.msg;
              errEl.classList.remove('hidden');
              return;
            }
            const v = validateInterval(rule.id, d);
            if (!v.ok) {
              errEl.textContent = v.msg;
              errEl.classList.remove('hidden');
              return;
            }
            // Tentukan payload—tanggal saja atau dengan batch (edit/new)
            let payload = d;
            const useBatch = !toggleWrap.classList.contains('hidden') ? cbAt.checked : !batchWrap.classList.contains('hidden');
            if (useBatch) {
              const code = batchSelect.value;
              const arr = DB.batches[rule.id] || [];
              const picked = arr.find(x => x.code === code);
              if (picked) {
                if (!picked.active || picked.exp < todayISO() || picked.dosesRemaining <= 0) {
                  alert('Batch tidak valid.');
                  return;
                }
                if (!hasRecord) picked.dosesRemaining--;
              }
              payload = {
                date: d,
                batch: code || null
              };
            }
            // If previously marked notGiven, overwrite with actual date record
            currentChild.records[rule.id] = payload;
            saveDB();
            refreshListIfVisible();
            renderProgramChips();
            renderVaxList();
          };
        });
        
if (byId('s-ideal')) byId('s-ideal').textContent = idealCount;
if (byId('s-kejar')) byId('s-kejar').textContent = kejarCount;
if (byId('s-pending')) byId('s-pending').textContent = pendingCount;
if (byId('s-notgiven')) byId('s-notgiven').textContent = notGiven;
// Back-compat for old cards
if (byId('s-done')) byId('s-done').textContent = idealCount;
if (byId('s-due')) byId('s-due').textContent = kejarCount;
if (byId('s-late')) byId('s-late').textContent = pendingCount;
// Back-compat for old cards
if (byId('s-done')) byId('s-done').textContent = idealCount;

        // mapped via compatibility above
        // mapped via compatibility above
        // mapped via compatibility above
      }
      // ====== PENIMBANGAN ======
      function renderMeasureList() {
        const wrap = byId('measure-list');
        const hasBirth = (currentChild.measures || []).some(m => m.type === 'birth');
        const data = (currentChild.measures || []).slice().sort((a, b) => b.date.localeCompare(a.date));
        let html = '';
        if (!hasBirth) {
          html += `      
                <div class="mb-3 rounded-xl border border-amber-200 bg-amber-50 p-3 text-amber-800 text-sm flex items-start justify-between">
                  <div>
                    <b>Belum ada penimbangan saat lahir.</b>
                    <br/>
                    <span class="text-amber-700">Tambahkan untuk baseline pertumbuhan.</span>
                  </div>
                  <button id="btnBirth" class="btn btn-primary ml-3">+ Tambah</button>
                </div>`;
        }
        if (!data.length) {
  html += `<p class="text-slate-500 text-sm">Belum ada riwayat penimbangan</p>`;
  wrap.innerHTML = html;
  if (!hasBirth) byId('btnBirth').onclick = () => openWeigh('birth');
  return;
}
        wrap.innerHTML = html;
        if (!hasBirth) {
          byId('btnBirth').onclick = () => openWeigh('birth');
        }
        data.forEach(m => {
          const bmi = (m.height > 0) ? (m.weight / Math.pow(m.height / 100, 2)) : null;
          const info = calcZAll(currentChild, m);
          const row = document.createElement('div');
          row.className = 'py-3 border-b last:border-0 border-slate-100';
          row.innerHTML = `
                              
                <div class="flex items-start justify-between">
                  <div>
                    <div class="font-medium text-slate-800">${fmtID(m.date)} ${m.type === 'birth' ? `
                      <span class="ml-2 badge b-amber">Lahir</span>` : ``}
                                  
                    </div>
                    <div class="text-sm text-slate-600">BB: 
                                    
                      <b>${m.weight}</b> kg · TB: 
                                    
                      <b>${m.height}</b> cm · IMT: 
                                    
                      <b>${bmi?bmi.toFixed(2):'-'}</b>
                    </div>
                    <div class="text-xs text-slate-500">Usia: ${ageLabel(currentChild.dob,m.date)}</div>
                  </div>
                  <div class="text-right text-xs text-slate-600">
                    <div>BB/U z: 
                                    
                      <b>${fmtZ(info.wfa)}</b>
                    </div>
                    <div>TB/U z: 
                                    
                      <b>${fmtZ(info.lhfa)}</b>
                    </div>
                    <div>IMT/U z: 
                                    
                      <b>${fmtZ(info.bfa)}</b>
                    </div>
                  </div>
                </div>`;
          wrap.appendChild(row);
        });
      }
      let WEIGH_MODE = 'visit';

      function openWeigh(mode = 'visit') {
        WEIGH_MODE = mode;
        nav('weigh');
        byId('w-child').textContent = `${currentChild.name} · NIK ${currentChild.nik}`;
        const isBirth = (mode === 'birth');
        const d = isBirth ? currentChild.dob : todayISO();
        const dateEl = byId('w-date');
        dateEl.value = d;
        dateEl.disabled = isBirth;
        byId('w-sex').value = currentChild.sex || 'M';
        updateWeighPreview();
        byId('w-date').oninput = updateWeighPreview;
        byId('w-weight').oninput = updateWeighPreview;
        byId('w-height').oninput = updateWeighPreview;
        byId('w-sex').oninput = (e) => {
          currentChild.sex = e.target.value;
          updateWeighPreview();
        };
        byId('w-save').onclick = () => {
          const isBirthSave = (WEIGH_MODE === 'birth');
          const date = isBirthSave ? currentChild.dob : byId('w-date').value;
          const weight = parseFloat(byId('w-weight').value);
          const height = parseFloat(byId('w-height').value);
          if (!date || isNaN(weight) || isNaN(height)) {
            alert('Lengkapi tanggal, berat, dan tinggi.');
            return;
          }
          currentChild.measures = currentChild.measures || [];
          if (isBirthSave) {
            const idx = (currentChild.measures || []).findIndex(m => m.type === 'birth');
            const entry = {
              type: 'birth',
              date,
              weight,
              height,
              sex: currentChild.sex
            };
            if (idx >= 0) currentChild.measures[idx] = entry;
            else currentChild.measures.push(entry);
          } else {
            currentChild.measures.push({
              type: 'visit',
              date,
              weight,
              height
            });
          }
          saveDB();
          refreshListIfVisible();
          byId('w-weight').value = '';
          byId('w-height').value = '';
          byId('w-date').disabled = false;
          nav('child');
          renderMeasureList();
        };
      }

      function updateWeighPreview() {
        const isBirth = (WEIGH_MODE === 'birth');
        const date = isBirth ? currentChild.dob : (byId('w-date').value || todayISO());
        const w = parseFloat(byId('w-weight').value);
        const h = parseFloat(byId('w-height').value);
        byId('w-age').textContent = ageLabel(currentChild.dob, date);
        const bmi = (!isNaN(w) && !isNaN(h) && h > 0) ? (w / Math.pow(h / 100, 2)) : NaN;
        byId('w-bmi').textContent = isNaN(bmi) ? '-' : bmi.toFixed(2);
        const info = (!isNaN(w) && !isNaN(h)) ? calcZAll(currentChild, {
          date,
          weight: w,
          height: h
        }) : {
          wfa: null,
          lhfa: null,
          bfa: null
        };
        byId('w-z').textContent = `${fmtZ(info.wfa)} / ${fmtZ(info.lhfa)} / ${fmtZ(info.bfa)}`;
      }
      // ====== WHO LMS (placeholder minimal) ======
      const WHO_LMS = {
        M: {
          wfa: {
            0: {
              L: 0.3487,
              M: 3.3,
              S: 0.14602
            },
            12: {
              L: -0.3521,
              M: 9.6,
              S: 0.12385
            },
            24: {
              L: -0.2061,
              M: 12.2,
              S: 0.1278
            },
            36: {
              L: -0.1257,
              M: 14.3,
              S: 0.1304
            },
            48: {
              L: -0.082,
              M: 16.3,
              S: 0.1333
            },
            60: {
              L: -0.04,
              M: 18.3,
              S: 0.1355
            }
          },
          lhfa: {
            0: {
              L: 1,
              M: 49.9,
              S: 0.03795
            },
            12: {
              L: 1,
              M: 75.7,
              S: 0.0349
            },
            24: {
              L: 1,
              M: 87.8,
              S: 0.0364
            },
            36: {
              L: 1,
              M: 96.1,
              S: 0.039
            },
            48: {
              L: 1,
              M: 103.3,
              S: 0.042
            },
            60: {
              L: 1,
              M: 110,
              S: 0.045
            }
          },
          bfa: {
            0: {
              L: -0.3053,
              M: 13.4,
              S: 0.0956
            },
            12: {
              L: -0.3521,
              M: 16.3,
              S: 0.0806
            },
            24: {
              L: -0.3833,
              M: 16.0,
              S: 0.0807
            },
            36: {
              L: -0.3521,
              M: 15.7,
              S: 0.081
            },
            48: {
              L: -0.3521,
              M: 15.6,
              S: 0.082
            },
            60: {
              L: -0.3521,
              M: 15.5,
              S: 0.083
            }
          }
        },
        F: {
          wfa: {
            0: {
              L: 0.3809,
              M: 3.2,
              S: 0.14171
            },
            12: {
              L: -0.3833,
              M: 8.9,
              S: 0.1278
            },
            24: {
              L: -0.2061,
              M: 11.5,
              S: 0.1311
            },
            36: {
              L: -0.1257,
              M: 13.9,
              S: 0.1343
            },
            48: {
              L: -0.082,
              M: 16,
              S: 0.137
            },
            60: {
              L: -0.04,
              M: 18.2,
              S: 0.14
            }
          },
          lhfa: {
            0: {
              L: 1,
              M: 49.1,
              S: 0.0379
            },
            12: {
              L: 1,
              M: 74.0,
              S: 0.0356
            },
            24: {
              L: 1,
              M: 86.4,
              S: 0.0374
            },
            36: {
              L: 1,
              M: 95.1,
              S: 0.0401
            },
            48: {
              L: 1,
              M: 102.7,
              S: 0.0432
            },
            60: {
              L: 1,
              M: 109.4,
              S: 0.046
            }
          },
          bfa: {
            0: {
              L: -0.3833,
              M: 13.3,
              S: 0.0946
            },
            12: {
              L: -0.3833,
              M: 16.1,
              S: 0.0811
            },
            24: {
              L: -0.3833,
              M: 16.0,
              S: 0.082
            },
            36: {
              L: -0.3833,
              M: 15.6,
              S: 0.083
            },
            48: {
              L: -0.3833,
              M: 15.5,
              S: 0.084
            },
            60: {
              L: -0.3833,
              M: 15.4,
              S: 0.085
            }
          }
        }
      };

      function monthAge(dob, ref) {
        const d = diffYMD(dob, ref);
        return d.years * 12 + d.months + d.days / 30.4375;
      }

      function lmsZ(x, {
        L,
        M,
        S
      }) {
        if (!isFinite(x) || !isFinite(L) || !isFinite(M) || !isFinite(S) || M <= 0 || S <= 0) return null;
        if (Math.abs(L) < 1e-8) return Math.log(x / M) / S;
        return (Math.pow(x / M, L) - 1) / (L * S);
      }

      function interpLMS(sex, metric, months) {
        const tbl = WHO_LMS[sex]?.[metric];
        if (!tbl) return null;
        const keys = Object.keys(tbl).map(k => +k).sort((a, b) => a - b);
        if (!keys.length) return null;
        if (months <= keys[0]) return tbl[keys[0]];
        if (months >= keys[keys.length - 1]) return tbl[keys[keys.length - 1]];
        for (let i = 0; i < keys.length - 1; i++) {
          const a = keys[i],
            b = keys[i + 1];
          if (months >= a && months <= b) {
            const t = (months - a) / (b - a);
            const A = tbl[a],
              B = tbl[b];
            return {
              L: A.L + (B.L - A.L) * t,
              M: A.M + (B.M - A.M) * t,
              S: A.S + (B.S - A.S) * t
            };
          }
        }
        return null;
      }

      function calcZAll(child, measure) {
        const sex = child.sex || 'M';
        const m = monthAge(child.dob, measure.date);
        const w = measure.weight;
        const h = measure.height;
        const bmi = (h > 0) ? (w / Math.pow(h / 100, 2)) : NaN;
        const W = interpLMS(sex, 'wfa', m);
        const H = interpLMS(sex, 'lhfa', m);
        const B = interpLMS(sex, 'bfa', m);
        return {
          wfa: W ? lmsZ(w, W) : null,
          lhfa: H ? lmsZ(h, H) : null,
          bfa: B ? lmsZ(bmi, B) : null
        }
      }

      function fmtZ(z) {
        if (z == null || !isFinite(z)) return '—';
        return z > 0 ? `+${z.toFixed(2)}` : z.toFixed(2);
      }
      // ====== Lightweight DEV tests (console) ======
      (function runTests() {
        try {
          const assert = (c, m) => {
            if (!c) throw new Error(m);
          };
          const saved = currentChild;
          let dob = '2024-01-31',
            ref = '2024-03-01';
          let lbl = ageLabel(dob, ref);
          assert(/0 tahun 1 bulan 1 hari/.test(lbl), 'ageLabel leap-year end-of-month');
          dob = '2023-01-31';
          ref = '2023-03-01';
          lbl = ageLabel(dob, ref);
          assert(/0 tahun 1 bulan 1 hari/.test(lbl), 'ageLabel non-leap end-of-month');
          assert(parseDOBFromNIK('0000003101240001') === '2024-01-31', 'parse NIK male');
          assert(sexFromNIK('0000007101240001') === 'F', 'sex female +40');
          currentChild = {
            dob: '2025-01-01',
            measures: [],
            records: {}
          };
          const before = currentChild.measures.length;
          currentChild.measures.push({
            date: '2025-02-01',
            weight: 5.1,
            height: 58
          });
          assert(currentChild.measures.length === before + 1, 'measure push works');
          const today = todayISO();
          currentChild.dob = addMonths(today, -1);
          const st = statusFor({
            ideal: {
              months: 1
            }
          });
          assert(st.type === 'late', 'should be belum dicatat');
          dob = '2025-01-31';
          ref = '2025-02-28';
          lbl = ageLabel(dob, ref);
          assert(/0 tahun 0 bulan 28 hari/.test(lbl), 'jan31 → feb28 non-leap');
          dob = '2024-01-31';
          ref = '2024-02-29';
          lbl = ageLabel(dob, ref);
          assert(/0 tahun 0 bulan 29 hari/.test(lbl), 'jan31 → feb29 leap');
          dob = '2024-02-29';
          ref = '2024-03-01';
          lbl = ageLabel(dob, ref);
          assert(/0 tahun 0 bulan 1 hari/.test(lbl), 'feb29 → mar1');
          dob = '2024-02-28';
          ref = '2024-03-01';
          lbl = ageLabel(dob, ref);
          assert(/0 tahun 0 bulan 2 hari/.test(lbl), 'feb28 → mar1');
          dob = '2024-08-31';
          ref = '2024-09-30';
          lbl = ageLabel(dob, ref);
          assert(/0 tahun 0 bulan 30 hari/.test(lbl), 'aug31 → sep30');
          currentChild = {
            dob: '2025-01-01',
            records: {
              opv1: '2025-02-01'
            }
          };
          let v = validateInterval('opv2', '2025-02-20');
          assert(v.ok === false, 'interval  < 28 days should block ');
          v = validateInterval('opv2', '2025-03-05');
          assert(v.ok === true, 'interval >=28 days should pass');
          currentChild = {
            dob: '2025-01-01',
            records: {}
          };
          v = validateInterval('opv2', '2025-03-05');
          assert(v.ok === false, 'missing previous dose should block');
          currentChild = {
            dob: '2025-01-01',
            records: {
              pcv1: '2025-02-01'
            }
          };
          v = validateInterval('pcv2', '2025-02-20');
          assert(v.ok === false, 'pcv gap  < 28 should block ');
          v = validateInterval('pcv2', '2025-03-01');
          assert(v.ok === true, 'pcv gap >=28 should pass');
          currentChild = {
            dob: '2025-01-10',
            records: {}
          };
          let w = validateDateWindow('bcg1', '2025-01-01');
          assert(w.ok === false && /sebelum tanggal lahir/i.test(w.msg), 'date before DOB should block');
          w = validateDateWindow('bcg1', '2025-01-15');
          assert(w.ok === false && /sebelum jadwal ideal/i.test(w.msg), 'date before ideal should block');
          currentChild = saved;
          console.log('%cDEV tests passed', 'color:green');
        } catch (e) {
          console.error('DEV test failed:', e.message);
        }
      })();

      function openList() {
        nav('list');
        renderChildList();
        const input = byId('list-search');
        if (input && !input._wired) {
          input.addEventListener('input', renderChildList);
          input._wired = true;
        }
      }

      function renderChildList() {
        const q = (byId('list-search')?.value || '').trim().toLowerCase();
        const wrap = byId('list-results');
        const entries = Object.values(DB.children || {});
        const filtered = entries.filter(c => {
          const name = (c.name || '').toLowerCase();
          const nik = (c.nik || '').toLowerCase();
          return !q || name.includes(q) || nik.includes(q);
        }).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        if (!filtered.length) {
          wrap.innerHTML = `
      
                                    
                <div class="card p-6 text-center text-slate-600">
        Belum ada data anak. Mulai dari 
                                      
                  <b>Catat Imunisasi</b>.
      
                                    
                </div>`;
          return;
        }
        wrap.innerHTML = '';
        filtered.forEach(c => {
          const usia = ageLabel(c.dob, todayISO());
          // hitung ringkas status
          let ideal = 0,
            kejar = 0,
            pending = 0;
          (RULES || []).forEach(r => {
            const st = (function() {
              const prev = currentChild;
              currentChild = c;
              const s = statusFor(r);
              currentChild = prev;
              return s;
            })();
            if (!st || st.type === 'hidden' || st.type === 'not_given') return;
            if (st.type === 'ideal') ideal++;
            else if (st.type === 'kejar') kejar++;
            else if (st.type === 'late' || st.type === 'due') pending++;
          });
          const row = document.createElement('div');
          row.className = 'card p-5 mb-3';
          row.innerHTML = `
  
                                    
                <div class="flex items-start justify-between gap-3">
                  <div class="min-w-0">
                    <div class="font-semibold text-slate-800">${c.name || '-'}</div>
                    <div class="text-sm text-slate-600">
        NIK: 
                                          
                      <b>${c.nik}</b> · Usia: ${usia}
      
                                        
                    </div>
                    <div class="text-xs text-slate-500 mt-1">
        ${ideal} jadwal ideal · ${kejar} jadwal kejar · ${pending} belum dicatat
      </div>
                  </div>
                  <!-- Chevron kanan -->
                  <div aria-hidden="true" class="shrink-0 h-10 w-10 grid place-items-center text-slate-400 group-hover:text-slate-600">
                    <svg
                      xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
           class="h-6 w-6" fill="none" stroke="currentColor"
           stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M8 4l8 8-8 8"/>
                    </svg>
                  </div>
                </div>
`;
          row.className = 'card p-5 mb-3 cursor-pointer transition ring-0 hover:ring-2 hover:ring-indigo-200 group';
          // seluruh card klik → buka detail anak
          row.setAttribute('role', 'button');
          row.setAttribute('tabindex', '0');
          row.addEventListener('click', () => openChild(c.nik));
          row.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              openChild(c.nik);
            }
          });
          wrap.appendChild(row);
        });
      }
      // Boot example
      // openChild('3574015706250002');
      // Boot
      if (!AUTH.loadSession()) {
        updateAuthUI(false);
        nav('login');
      } else {
        updateAuthUI(true);
        nav('hub'); // ← menuju landing baru
      }
    </script>
  </body>
</html>
